<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Training Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #ffffff; }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); }
        .accent-gradient { background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%); }
        .accent-text { color: #10b981; }
        .accent-border { border-color: #10b981; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(16, 185, 129, 0.1); }
        .sidebar-item.active { background: rgba(16, 185, 129, 0.15); border-left: 2px solid #10b981; }
        .input-dark { background: #111111; border: 1px solid rgba(255,255,255,0.1); color: white; }
        .input-dark:focus { border-color: #10b981; outline: none; }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .stat-card { background: linear-gradient(180deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0) 100%); }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .toast { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="flex min-h-screen">
        <!-- Toast Notifications -->
        <div class="fixed top-4 right-4 z-50 space-y-2">
            <div v-for="toast in toasts" :key="toast.id"
                 :class="['toast glass-card rounded-lg p-4 flex items-center gap-3 min-w-80',
                          toast.type === 'error' ? 'border-red-500/50' : toast.type === 'success' ? 'border-green-500/50' : 'border-blue-500/50']">
                <i :data-lucide="toast.type === 'error' ? 'alert-circle' : toast.type === 'success' ? 'check-circle' : 'info'"
                   :class="['w-5 h-5', toast.type === 'error' ? 'text-red-400' : toast.type === 'success' ? 'text-green-400' : 'text-blue-400']"></i>
                <span class="text-sm">{{ toast.message }}</span>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="w-64 bg-[#0a0a0a] border-r border-white/5 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl accent-gradient flex items-center justify-center">
                        <i data-lucide="brain" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-semibold text-lg">Training Platform</h1>
                        <p class="text-xs text-gray-500">verl-based</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-1">
                <a href="#" @click.prevent="currentPage = 'dashboard'; loadDashboard()"
                   :class="['sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentPage === 'dashboard' ? 'active text-white' : 'text-gray-400']">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    Dashboard
                </a>
                <a href="#" @click.prevent="currentPage = 'compute'"
                   :class="['sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentPage === 'compute' ? 'active text-white' : 'text-gray-400']">
                    <i data-lucide="calculator" class="w-5 h-5"></i>
                    Compute Calculator
                </a>
                <a href="#" @click.prevent="currentPage = 'jobs'; loadJobs()"
                   :class="['sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentPage === 'jobs' ? 'active text-white' : 'text-gray-400']">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                    Training Jobs
                </a>
                <a href="#" @click.prevent="currentPage = 'surgery'"
                   :class="['sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentPage === 'surgery' ? 'active text-white' : 'text-gray-400']">
                    <i data-lucide="git-merge" class="w-5 h-5"></i>
                    Model Surgery
                </a>
                <a href="#" @click.prevent="currentPage = 'monitoring'; startMonitoring()"
                   :class="['sidebar-item flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentPage === 'monitoring' ? 'active text-white' : 'text-gray-400']">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                    Monitoring
                </a>
            </nav>

            <!-- API Status -->
            <div class="p-4 border-t border-white/5">
                <div class="flex items-center gap-3 px-4 py-2">
                    <div :class="['w-2 h-2 rounded-full', apiConnected ? 'bg-green-400' : 'bg-red-400']"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">API {{ apiConnected ? 'Connected' : 'Disconnected' }}</p>
                        <p class="text-xs text-gray-500">{{ apiUrl }}</p>
                    </div>
                    <button @click="checkApiConnection" class="p-1 hover:bg-white/5 rounded">
                        <i data-lucide="refresh-cw" class="w-4 h-4 text-gray-400"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-[#0a0a0a]/50 backdrop-blur sticky top-0 z-10">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-semibold capitalize">{{ currentPage.replace('-', ' ') }}</h2>
                    <span v-if="loading" class="loading text-sm text-gray-400">Loading...</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="showSettings = true" class="p-2 rounded-lg hover:bg-white/5 text-gray-400">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div class="p-8">
                <!-- Dashboard Page -->
                <div v-if="currentPage === 'dashboard'">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-card rounded-2xl p-6 stat-card">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-gray-400 text-sm">Active Jobs</span>
                                <i data-lucide="play" class="w-5 h-5 accent-text"></i>
                            </div>
                            <p class="text-3xl font-semibold">{{ dashboard.active_jobs }}</p>
                            <p class="text-xs text-gray-500 mt-2">{{ dashboard.queued_jobs }} queued</p>
                        </div>
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-gray-400 text-sm">GPU Hours</span>
                                <i data-lucide="cpu" class="w-5 h-5 text-cyan-400"></i>
                            </div>
                            <p class="text-3xl font-semibold">{{ dashboard.total_gpu_hours?.toFixed(1) || 0 }}</p>
                            <p class="text-xs text-gray-500 mt-2">This month</p>
                        </div>
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-gray-400 text-sm">Completed</span>
                                <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                            </div>
                            <p class="text-3xl font-semibold">{{ dashboard.completed_jobs }}</p>
                            <p class="text-xs text-gray-500 mt-2">{{ dashboard.failed_jobs }} failed</p>
                        </div>
                        <div class="glass-card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-gray-400 text-sm">Tokens Trained</span>
                                <i data-lucide="hash" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <p class="text-3xl font-semibold">{{ formatTokens(dashboard.total_training_tokens) }}</p>
                            <p class="text-xs text-gray-500 mt-2">Total</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <button @click="currentPage = 'compute'" class="glass-card rounded-2xl p-6 text-left hover:border-emerald-500/30 transition-colors group">
                            <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center mb-4 group-hover:bg-emerald-500/20">
                                <i data-lucide="calculator" class="w-6 h-6 accent-text"></i>
                            </div>
                            <h3 class="font-medium mb-2">Compute Calculator</h3>
                            <p class="text-sm text-gray-400">Calculate optimal GPU and batch size configurations</p>
                        </button>
                        <button @click="currentPage = 'jobs'; showNewJobModal = true" class="glass-card rounded-2xl p-6 text-left hover:border-cyan-500/30 transition-colors group">
                            <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center mb-4 group-hover:bg-cyan-500/20">
                                <i data-lucide="plus-circle" class="w-6 h-6 text-cyan-400"></i>
                            </div>
                            <h3 class="font-medium mb-2">New Training Job</h3>
                            <p class="text-sm text-gray-400">Start a new SFT, PPO, GRPO, or DPO training</p>
                        </button>
                        <button @click="currentPage = 'surgery'" class="glass-card rounded-2xl p-6 text-left hover:border-purple-500/30 transition-colors group">
                            <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center mb-4 group-hover:bg-purple-500/20">
                                <i data-lucide="git-merge" class="w-6 h-6 text-purple-400"></i>
                            </div>
                            <h3 class="font-medium mb-2">Model Surgery</h3>
                            <p class="text-sm text-gray-400">Merge models or select best checkpoints</p>
                        </button>
                    </div>

                    <!-- Top Experiments & Alerts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-medium mb-4">Top Performing Experiments</h3>
                            <div class="space-y-3">
                                <div v-for="exp in dashboard.top_performing_experiments" :key="exp.name"
                                     class="flex items-center justify-between py-2 border-b border-white/5">
                                    <span class="font-medium">{{ exp.name }}</span>
                                    <div class="flex gap-4 text-sm">
                                        <span v-if="exp.gsm8k" class="text-gray-400">GSM8K: <span class="accent-text">{{ exp.gsm8k }}%</span></span>
                                        <span v-if="exp.math" class="text-gray-400">MATH: <span class="accent-text">{{ exp.math }}%</span></span>
                                        <span v-if="exp.humaneval" class="text-gray-400">HumanEval: <span class="accent-text">{{ exp.humaneval }}%</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-medium mb-4">Recent Alerts</h3>
                            <div class="space-y-3">
                                <div v-for="alert in dashboard.recent_alerts" :key="alert.job_id"
                                     :class="['flex items-center gap-3 py-2 px-3 rounded-lg',
                                              alert.severity === 'warning' ? 'bg-yellow-500/10' : 'bg-red-500/10']">
                                    <i data-lucide="alert-triangle" :class="['w-4 h-4', alert.severity === 'warning' ? 'text-yellow-400' : 'text-red-400']"></i>
                                    <div class="flex-1">
                                        <p class="text-sm">{{ alert.message }}</p>
                                        <p class="text-xs text-gray-500">Job: {{ alert.job_id }}</p>
                                    </div>
                                </div>
                                <p v-if="!dashboard.recent_alerts?.length" class="text-gray-500 text-sm">No recent alerts</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compute Calculator Page -->
                <div v-if="currentPage === 'compute'">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Input Panel -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-medium mb-6 flex items-center gap-2">
                                <i data-lucide="settings" class="w-5 h-5 accent-text"></i>
                                Configuration
                            </h3>

                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Model Size</label>
                                    <select v-model="compute.modelSize" class="w-full input-dark rounded-lg px-4 py-3">
                                        <option v-for="size in modelSizes" :key="size.id" :value="size.id">
                                            {{ size.name }} ({{ size.params_billion }}B params)
                                        </option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">GPU Type</label>
                                    <select v-model="compute.gpuType" class="w-full input-dark rounded-lg px-4 py-3">
                                        <option v-for="gpu in gpuTypes" :key="gpu.id" :value="gpu.id">
                                            {{ gpu.name }} ({{ gpu.memory_gb }}GB)
                                        </option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Number of GPUs</label>
                                    <input type="number" v-model.number="compute.numGpus" min="1" max="1024" class="w-full input-dark rounded-lg px-4 py-3">
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Context Length</label>
                                    <select v-model="compute.contextLength" class="w-full input-dark rounded-lg px-4 py-3">
                                        <option :value="1024">1K</option>
                                        <option :value="2048">2K</option>
                                        <option :value="4096">4K</option>
                                        <option :value="8192">8K</option>
                                        <option :value="16384">16K</option>
                                        <option :value="32768">32K</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Training Type</label>
                                    <select v-model="compute.trainingType" class="w-full input-dark rounded-lg px-4 py-3">
                                        <option value="sft">SFT (Supervised Fine-Tuning)</option>
                                        <option value="ppo">PPO (Proximal Policy Optimization)</option>
                                        <option value="grpo">GRPO (Group Relative Policy Optimization)</option>
                                        <option value="dpo">DPO (Direct Preference Optimization)</option>
                                        <option value="gspo">GSPO (Group Self-Play Preference Optimization)</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" v-model="compute.loraEnabled" class="w-4 h-4 accent-emerald-500">
                                        <span class="text-sm">Enable LoRA</span>
                                    </label>
                                    <input v-if="compute.loraEnabled" type="number" v-model.number="compute.loraRank" min="1" max="256"
                                           placeholder="Rank" class="w-24 input-dark rounded-lg px-3 py-2 text-sm">
                                </div>

                                <button @click="calculateCompute" :disabled="computeLoading"
                                        class="w-full btn-primary text-black py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                                    <span v-if="computeLoading" class="loading">Calculating...</span>
                                    <span v-else>Calculate Configuration</span>
                                </button>
                            </div>
                        </div>

                        <!-- Results Panel -->
                        <div class="space-y-6">
                            <!-- Memory Breakdown -->
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-medium mb-6 flex items-center gap-2">
                                    <i data-lucide="hard-drive" class="w-5 h-5 accent-text"></i>
                                    Memory Breakdown
                                </h3>

                                <div class="mb-6">
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">GPU Memory Usage</span>
                                        <span :class="computeResult.memory?.utilization > 90 ? 'text-red-400' : 'accent-text'">
                                            {{ computeResult.memory?.perGpu?.toFixed(1) || 0 }} / {{ getGpuMemory() }} GB
                                            ({{ computeResult.memory?.utilization?.toFixed(1) || 0 }}%)
                                        </span>
                                    </div>
                                    <div class="w-full bg-gray-800 rounded-full h-4">
                                        <div :class="['h-4 rounded-full transition-all', computeResult.memory?.utilization > 90 ? 'bg-red-500' : 'accent-gradient']"
                                             :style="{width: Math.min(computeResult.memory?.utilization || 0, 100) + '%'}"></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="bg-white/5 rounded-lg p-3">
                                        <span class="text-gray-400">Model Weights</span>
                                        <p class="font-medium">{{ computeResult.memory?.modelWeights?.toFixed(2) || 0 }} GB</p>
                                    </div>
                                    <div class="bg-white/5 rounded-lg p-3">
                                        <span class="text-gray-400">Optimizer States</span>
                                        <p class="font-medium">{{ computeResult.memory?.optimizer?.toFixed(2) || 0 }} GB</p>
                                    </div>
                                    <div class="bg-white/5 rounded-lg p-3">
                                        <span class="text-gray-400">Gradients</span>
                                        <p class="font-medium">{{ computeResult.memory?.gradients?.toFixed(2) || 0 }} GB</p>
                                    </div>
                                    <div class="bg-white/5 rounded-lg p-3">
                                        <span class="text-gray-400">Activations</span>
                                        <p class="font-medium">{{ computeResult.memory?.activations?.toFixed(2) || 0 }} GB</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Recommended Config -->
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-medium mb-6 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 accent-text"></i>
                                    Recommended Configuration
                                </h3>

                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-gray-400">ZeRO Stage</span>
                                        <span class="font-medium">ZeRO-{{ computeResult.config?.zeroStage || 2 }}</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-gray-400">Micro Batch Size</span>
                                        <span class="font-medium">{{ computeResult.config?.microBatchSize || 4 }}</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-gray-400">Gradient Accumulation</span>
                                        <span class="font-medium">{{ computeResult.config?.gradientAccum || 8 }}</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-gray-400">Global Batch Size</span>
                                        <span class="font-medium">{{ computeResult.config?.globalBatchSize || 256 }}</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-gray-400">Tensor Parallel</span>
                                        <span class="font-medium">{{ computeResult.config?.tensorParallel || 1 }}</span>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-gray-400">Learning Rate</span>
                                        <span class="font-medium">{{ computeResult.config?.learningRate || '1e-6' }}</span>
                                    </div>
                                </div>

                                <div v-if="computeResult.warnings?.length" class="mt-4 space-y-2">
                                    <div v-for="warning in computeResult.warnings" :key="warning.message"
                                         :class="['text-sm px-3 py-2 rounded-lg', warning.level === 'error' ? 'bg-red-500/10 text-red-400' : 'bg-yellow-500/10 text-yellow-400']">
                                        {{ warning.message }}
                                    </div>
                                </div>

                                <div v-if="computeResult.recommendations?.length" class="mt-4 space-y-2">
                                    <div v-for="rec in computeResult.recommendations" :key="rec"
                                         class="text-sm px-3 py-2 rounded-lg bg-blue-500/10 text-blue-400">
                                        {{ rec }}
                                    </div>
                                </div>

                                <button @click="exportYaml" v-if="computeResult.yaml"
                                        class="w-full mt-6 border border-white/10 text-white py-3 rounded-lg font-medium hover:bg-white/5 transition-colors">
                                    Export YAML Config
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Jobs Page -->
                <div v-if="currentPage === 'jobs'">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-2">
                            <button v-for="filter in ['all', 'running', 'completed', 'failed', 'pending']" :key="filter"
                                    @click="jobFilter = filter"
                                    :class="['px-4 py-2 rounded-lg text-sm capitalize', jobFilter === filter ? 'bg-emerald-500/20 accent-text' : 'bg-white/5 text-gray-400']">
                                {{ filter }}
                            </button>
                        </div>
                        <button @click="showNewJobModal = true" class="btn-primary text-black px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            New Job
                        </button>
                    </div>

                    <!-- Jobs List -->
                    <div class="space-y-4">
                        <div v-if="jobs.length === 0" class="glass-card rounded-2xl p-12 text-center">
                            <i data-lucide="inbox" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i>
                            <p class="text-gray-400">No training jobs yet. Create your first job!</p>
                        </div>
                        <div v-for="job in filteredJobs" :key="job.id" class="glass-card rounded-2xl p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h4 class="font-medium">{{ job.name }}</h4>
                                        <span :class="['px-2 py-1 rounded text-xs', getStatusClass(job.status)]">{{ job.status }}</span>
                                        <span class="px-2 py-1 rounded bg-white/5 text-xs uppercase">{{ job.algorithm }}</span>
                                        <span v-if="job.lora_enabled" class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs">LoRA</span>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-4">
                                        {{ job.model_path?.split('/').pop() }} | {{ job.num_gpus }} GPUs |
                                        Created {{ formatDate(job.created_at) }}
                                    </p>

                                    <div class="flex items-center gap-6">
                                        <div>
                                            <span class="text-xs text-gray-500">Progress</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-32 bg-gray-800 rounded-full h-2">
                                                    <div class="accent-gradient h-2 rounded-full"
                                                         :style="{width: getJobProgress(job) + '%'}"></div>
                                                </div>
                                                <span class="text-sm">{{ getJobProgress(job) }}%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="text-xs text-gray-500">Step</span>
                                            <p class="text-sm font-medium">{{ job.current_step || 0 }} / {{ job.total_steps || '?' }}</p>
                                        </div>
                                        <div v-if="job.latest_metrics">
                                            <span class="text-xs text-gray-500">Reward</span>
                                            <p class="text-sm font-medium accent-text">{{ job.latest_metrics.reward_mean?.toFixed(3) || 'N/A' }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button v-if="job.status === 'pending'" @click="startJob(job.id)"
                                            class="p-2 rounded-lg hover:bg-green-500/20" title="Start">
                                        <i data-lucide="play" class="w-5 h-5 text-green-400"></i>
                                    </button>
                                    <button v-if="job.status === 'running'" @click="pauseJob(job.id)"
                                            class="p-2 rounded-lg hover:bg-yellow-500/20" title="Pause">
                                        <i data-lucide="pause" class="w-5 h-5 text-yellow-400"></i>
                                    </button>
                                    <button v-if="job.status === 'paused'" @click="resumeJob(job.id)"
                                            class="p-2 rounded-lg hover:bg-green-500/20" title="Resume">
                                        <i data-lucide="play" class="w-5 h-5 text-green-400"></i>
                                    </button>
                                    <button v-if="['running', 'queued'].includes(job.status)" @click="stopJob(job.id)"
                                            class="p-2 rounded-lg hover:bg-red-500/20" title="Stop">
                                        <i data-lucide="square" class="w-5 h-5 text-red-400"></i>
                                    </button>
                                    <button @click="viewJobDetails(job)" class="p-2 rounded-lg hover:bg-white/5" title="View Details">
                                        <i data-lucide="external-link" class="w-5 h-5 text-gray-400"></i>
                                    </button>
                                    <button @click="deleteJob(job.id)" class="p-2 rounded-lg hover:bg-red-500/20" title="Delete">
                                        <i data-lucide="trash-2" class="w-5 h-5 text-gray-400"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Surgery Page -->
                <div v-if="currentPage === 'surgery'">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Model Merge -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-medium mb-6 flex items-center gap-2">
                                <i data-lucide="git-merge" class="w-5 h-5 accent-text"></i>
                                Model Merging
                            </h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Base Model Path</label>
                                    <input type="text" v-model="merge.baseModel" placeholder="/path/to/base/model"
                                           class="w-full input-dark rounded-lg px-4 py-3">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Fine-tuned Model Path</label>
                                    <input type="text" v-model="merge.finetuneModel" placeholder="/path/to/finetuned/model"
                                           class="w-full input-dark rounded-lg px-4 py-3">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Merge Method</label>
                                    <select v-model="merge.method" class="w-full input-dark rounded-lg px-4 py-3">
                                        <option value="slerp">SLERP (Recommended for 2 models)</option>
                                        <option value="linear">Linear Interpolation</option>
                                        <option value="ties">TIES (TrIm, Elect Sign & Merge)</option>
                                        <option value="dare">DARE (Drop And REscale)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">
                                        Interpolation (t = {{ merge.t.toFixed(2) }})
                                    </label>
                                    <input type="range" v-model.number="merge.t" min="0" max="1" step="0.05" class="w-full">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Base (0.0)</span>
                                        <span>Fine-tuned (1.0)</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Output Path</label>
                                    <input type="text" v-model="merge.outputPath" placeholder="/path/to/output"
                                           class="w-full input-dark rounded-lg px-4 py-3">
                                </div>
                                <button @click="mergeModels" :disabled="mergeLoading || !merge.baseModel || !merge.finetuneModel"
                                        class="w-full btn-primary text-black py-3 rounded-lg font-medium">
                                    <span v-if="mergeLoading" class="loading">Merging...</span>
                                    <span v-else>Merge Models</span>
                                </button>

                                <div v-if="mergeResult" :class="['mt-4 p-4 rounded-lg', mergeResult.success ? 'bg-green-500/10' : 'bg-red-500/10']">
                                    <p :class="['text-sm', mergeResult.success ? 'text-green-400' : 'text-red-400']">
                                        {{ mergeResult.message }}
                                    </p>
                                    <p v-if="mergeResult.output_path" class="text-xs text-gray-400 mt-1">
                                        Output: {{ mergeResult.output_path }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Checkpoint Selection -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-medium mb-6 flex items-center gap-2">
                                <i data-lucide="check-square" class="w-5 h-5 accent-text"></i>
                                Checkpoint Selection
                            </h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Experiment Path</label>
                                    <input type="text" v-model="checkpoint.experimentPath" placeholder="/path/to/experiment"
                                           class="w-full input-dark rounded-lg px-4 py-3">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Selection Criteria</label>
                                    <select v-model="checkpoint.criteria" class="w-full input-dark rounded-lg px-4 py-3">
                                        <option value="balanced">Balanced (Recommended)</option>
                                        <option value="highest_reward">Highest Reward</option>
                                        <option value="highest_benchmark">Highest Benchmark</option>
                                        <option value="lowest_kl">Lowest KL Divergence</option>
                                        <option value="custom">Custom Formula</option>
                                    </select>
                                </div>
                                <div v-if="checkpoint.criteria === 'custom'">
                                    <label class="block text-sm text-gray-400 mb-2">Custom Formula</label>
                                    <input type="text" v-model="checkpoint.customFormula"
                                           placeholder="0.5*gsm8k + 0.3*math - 0.2*kl"
                                           class="w-full input-dark rounded-lg px-4 py-3">
                                    <p class="text-xs text-gray-500 mt-1">Variables: reward, kl, gsm8k, math, humaneval, mmlu</p>
                                </div>
                                <button @click="selectCheckpoint" :disabled="checkpointLoading || !checkpoint.experimentPath"
                                        class="w-full btn-primary text-black py-3 rounded-lg font-medium">
                                    <span v-if="checkpointLoading" class="loading">Analyzing...</span>
                                    <span v-else>Find Best Checkpoint</span>
                                </button>

                                <!-- Results -->
                                <div v-if="checkpointResult?.success" class="mt-6 p-4 bg-white/5 rounded-lg">
                                    <h4 class="font-medium mb-3">
                                        Recommended: Step {{ checkpointResult.recommended?.step }}
                                    </h4>
                                    <p class="text-sm text-gray-400 mb-3">{{ checkpointResult.reasoning }}</p>
                                    <div class="grid grid-cols-2 gap-3 text-sm">
                                        <div v-if="checkpointResult.recommended?.reward_mean">
                                            <span class="text-gray-400">Reward</span>
                                            <p class="font-medium">{{ checkpointResult.recommended.reward_mean.toFixed(3) }}</p>
                                        </div>
                                        <div v-if="checkpointResult.recommended?.benchmarks?.gsm8k">
                                            <span class="text-gray-400">GSM8K</span>
                                            <p class="font-medium">{{ checkpointResult.recommended.benchmarks.gsm8k.toFixed(1) }}%</p>
                                        </div>
                                        <div v-if="checkpointResult.recommended?.benchmarks?.math">
                                            <span class="text-gray-400">MATH</span>
                                            <p class="font-medium">{{ checkpointResult.recommended.benchmarks.math.toFixed(1) }}%</p>
                                        </div>
                                        <div v-if="checkpointResult.recommended?.kl_divergence">
                                            <span class="text-gray-400">KL</span>
                                            <p class="font-medium">{{ checkpointResult.recommended.kl_divergence.toFixed(4) }}</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3">Path: {{ checkpointResult.recommended?.path }}</p>
                                </div>
                                <div v-if="checkpointResult && !checkpointResult.success" class="mt-4 p-4 bg-red-500/10 rounded-lg">
                                    <p class="text-sm text-red-400">{{ checkpointResult.message }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SWA Section -->
                    <div class="glass-card rounded-2xl p-6 mt-8">
                        <h3 class="font-medium mb-6 flex items-center gap-2">
                            <i data-lucide="layers" class="w-5 h-5 accent-text"></i>
                            Stochastic Weight Averaging (SWA)
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Checkpoint Paths (one per line)</label>
                                    <textarea v-model="swa.checkpointPaths" rows="4"
                                              placeholder="/path/to/ckpt-1000&#10;/path/to/ckpt-2000&#10;/path/to/ckpt-3000"
                                              class="w-full input-dark rounded-lg px-4 py-3"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Output Path</label>
                                    <input type="text" v-model="swa.outputPath" placeholder="/path/to/swa-output"
                                           class="w-full input-dark rounded-lg px-4 py-3">
                                </div>
                                <button @click="performSWA" :disabled="swaLoading" class="btn-primary text-black py-3 px-6 rounded-lg font-medium">
                                    <span v-if="swaLoading" class="loading">Averaging...</span>
                                    <span v-else>Average Weights</span>
                                </button>
                            </div>
                            <div class="bg-white/5 rounded-lg p-4">
                                <h4 class="font-medium mb-3">About SWA</h4>
                                <p class="text-sm text-gray-400">
                                    Stochastic Weight Averaging averages weights from multiple checkpoints of the same training run.
                                    This often leads to better generalization than using the final checkpoint alone.
                                </p>
                                <ul class="text-sm text-gray-400 mt-3 space-y-1">
                                    <li>• Use checkpoints from the last ~20% of training</li>
                                    <li>• 3-5 checkpoints typically work well</li>
                                    <li>• Can improve accuracy by 1-2%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Page -->
                <div v-if="currentPage === 'monitoring'">
                    <!-- Job Selector -->
                    <div class="mb-6">
                        <label class="block text-sm text-gray-400 mb-2">Select Job to Monitor</label>
                        <select v-model="monitoring.selectedJobId" @change="loadJobMonitoring"
                                class="w-64 input-dark rounded-lg px-4 py-3">
                            <option value="">-- Select a job --</option>
                            <option v-for="job in runningJobs" :key="job.id" :value="job.id">
                                {{ job.name }} ({{ job.status }})
                            </option>
                        </select>
                    </div>

                    <div v-if="monitoring.selectedJobId">
                        <!-- Metrics Cards -->
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm text-gray-400 mb-2">Policy Loss</h4>
                                <p class="text-3xl font-semibold">{{ monitoring.metrics.policy_loss?.toFixed(4) || 'N/A' }}</p>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm text-gray-400 mb-2">Mean Reward</h4>
                                <p class="text-3xl font-semibold accent-text">{{ monitoring.metrics.reward_mean?.toFixed(3) || 'N/A' }}</p>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm text-gray-400 mb-2">KL Divergence</h4>
                                <p class="text-3xl font-semibold">{{ monitoring.metrics.kl_divergence?.toFixed(4) || 'N/A' }}</p>
                                <span :class="['text-xs', monitoring.metrics.kl_divergence > 0.1 ? 'text-yellow-400' : 'text-gray-500']">
                                    {{ monitoring.metrics.kl_divergence > 0.1 ? 'Above threshold' : 'Normal' }}
                                </span>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="text-sm text-gray-400 mb-2">Throughput</h4>
                                <p class="text-3xl font-semibold">{{ monitoring.metrics.throughput_tokens_per_sec?.toFixed(0) || 'N/A' }}</p>
                                <span class="text-xs text-gray-500">tokens/sec</span>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-medium mb-4">Training Loss</h3>
                                <canvas id="lossChart" height="200"></canvas>
                            </div>
                            <div class="glass-card rounded-2xl p-6">
                                <h3 class="font-medium mb-4">Reward Progress</h3>
                                <canvas id="rewardChart" height="200"></canvas>
                            </div>
                        </div>

                        <!-- GPU Usage -->
                        <div class="glass-card rounded-2xl p-6 mb-8">
                            <h3 class="font-medium mb-4">GPU Utilization</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                                <div v-for="(util, i) in monitoring.resources.gpu_utilization" :key="i" class="bg-white/5 rounded-lg p-4">
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">GPU {{ i }}</span>
                                        <span>{{ util?.toFixed(0) }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-800 rounded-full h-2 mb-2">
                                        <div class="accent-gradient h-2 rounded-full" :style="{width: util + '%'}"></div>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ monitoring.resources.gpu_memory_used?.[i]?.toFixed(1) || 0 }} /
                                        {{ monitoring.resources.gpu_memory_total?.[i] || 80 }} GB
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gradient Heatmap -->
                        <div class="glass-card rounded-2xl p-6 mb-8">
                            <h3 class="font-medium mb-4">Gradient Heatmap</h3>
                            <div v-if="monitoring.gradientData.layers?.length" class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-left py-2 px-3 text-gray-400">Layer</th>
                                            <th v-for="step in monitoring.gradientData.steps" :key="step"
                                                class="py-2 px-2 text-gray-400">{{ step }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(layer, li) in monitoring.gradientData.layers" :key="layer">
                                            <td class="py-2 px-3 text-gray-300 text-xs">{{ layer }}</td>
                                            <td v-for="(val, si) in monitoring.gradientData.data[li]" :key="si"
                                                :style="{backgroundColor: getHeatmapColor(val)}"
                                                class="py-2 px-2 text-center text-xs">
                                                {{ val.toFixed(3) }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p v-else class="text-gray-500 text-sm">Loading gradient data...</p>
                        </div>

                        <!-- Evaluations -->
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-medium mb-4">Evaluation Results</h3>
                            <div v-if="monitoring.evaluations.length" class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-left border-b border-white/5">
                                            <th class="py-3 px-4 text-gray-400">Checkpoint</th>
                                            <th class="py-3 px-4 text-gray-400">Benchmark</th>
                                            <th class="py-3 px-4 text-gray-400">Score</th>
                                            <th class="py-3 px-4 text-gray-400">Samples</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="eval in monitoring.evaluations" :key="`${eval.checkpoint_step}-${eval.benchmark}`"
                                            class="border-b border-white/5">
                                            <td class="py-3 px-4">Step {{ eval.checkpoint_step }}</td>
                                            <td class="py-3 px-4 uppercase">{{ eval.benchmark }}</td>
                                            <td class="py-3 px-4 accent-text font-medium">{{ eval.score.toFixed(1) }}%</td>
                                            <td class="py-3 px-4 text-gray-400">{{ eval.num_samples }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p v-else class="text-gray-500 text-sm">No evaluation results yet</p>
                        </div>
                    </div>

                    <div v-else class="glass-card rounded-2xl p-12 text-center">
                        <i data-lucide="activity" class="w-12 h-12 text-gray-600 mx-auto mb-4"></i>
                        <p class="text-gray-400">Select a running job to view monitoring data</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- New Job Modal -->
        <div v-if="showNewJobModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" @click.self="showNewJobModal = false">
            <div class="glass-card rounded-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">Create New Training Job</h3>
                    <button @click="showNewJobModal = false" class="p-2 hover:bg-white/5 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Job Name *</label>
                            <input type="text" v-model="newJob.name" placeholder="my-training-job"
                                   class="w-full input-dark rounded-lg px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Algorithm *</label>
                            <select v-model="newJob.algorithm" class="w-full input-dark rounded-lg px-4 py-3">
                                <option value="grpo">GRPO</option>
                                <option value="ppo">PPO</option>
                                <option value="dpo">DPO</option>
                                <option value="sft">SFT</option>
                                <option value="gspo">GSPO</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Model Path *</label>
                        <input type="text" v-model="newJob.model_path" placeholder="/path/to/model"
                               class="w-full input-dark rounded-lg px-4 py-3">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Training Data Path *</label>
                        <input type="text" v-model="newJob.train_data_path" placeholder="/path/to/train_data.jsonl"
                               class="w-full input-dark rounded-lg px-4 py-3">
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Number of GPUs</label>
                            <input type="number" v-model.number="newJob.num_gpus" min="1" max="1024"
                                   class="w-full input-dark rounded-lg px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">GPU Type</label>
                            <select v-model="newJob.gpu_type" class="w-full input-dark rounded-lg px-4 py-3">
                                <option v-for="gpu in gpuTypes" :key="gpu.id" :value="gpu.id">{{ gpu.name }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Batch Size</label>
                            <input type="number" v-model.number="newJob.batch_size" min="1"
                                   class="w-full input-dark rounded-lg px-4 py-3">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Learning Rate</label>
                            <input type="text" v-model="newJob.learning_rate" placeholder="1e-6"
                                   class="w-full input-dark rounded-lg px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Epochs</label>
                            <input type="number" v-model.number="newJob.num_epochs" min="1"
                                   class="w-full input-dark rounded-lg px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Context Length</label>
                            <input type="number" v-model.number="newJob.context_length"
                                   class="w-full input-dark rounded-lg px-4 py-3">
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" v-model="newJob.lora_enabled" class="w-4 h-4 accent-emerald-500">
                            <span class="text-sm">Enable LoRA</span>
                        </label>
                        <input v-if="newJob.lora_enabled" type="number" v-model.number="newJob.lora_rank"
                               min="1" max="256" placeholder="Rank" class="w-24 input-dark rounded-lg px-3 py-2 text-sm">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Description</label>
                        <textarea v-model="newJob.description" rows="2" placeholder="Optional description..."
                                  class="w-full input-dark rounded-lg px-4 py-3"></textarea>
                    </div>

                    <div class="flex justify-end gap-4">
                        <button @click="showNewJobModal = false"
                                class="px-6 py-3 rounded-lg border border-white/10 hover:bg-white/5">
                            Cancel
                        </button>
                        <button @click="createJob" :disabled="!newJob.name || !newJob.model_path || !newJob.train_data_path"
                                class="btn-primary text-black px-6 py-3 rounded-lg font-medium">
                            Create Job
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" @click.self="showSettings = false">
            <div class="glass-card rounded-2xl p-8 w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">Settings</h3>
                    <button @click="showSettings = false" class="p-2 hover:bg-white/5 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API URL</label>
                        <input type="text" v-model="apiUrl" class="w-full input-dark rounded-lg px-4 py-3">
                    </div>
                    <button @click="checkApiConnection" class="btn-primary text-black px-6 py-3 rounded-lg font-medium w-full">
                        Test Connection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    apiUrl: 'http://localhost:8000',
                    apiConnected: false,
                    loading: false,
                    currentPage: 'dashboard',
                    jobFilter: 'all',
                    showNewJobModal: false,
                    showSettings: false,
                    toasts: [],

                    // Dashboard
                    dashboard: {
                        active_jobs: 0,
                        queued_jobs: 0,
                        completed_jobs: 0,
                        failed_jobs: 0,
                        total_gpu_hours: 0,
                        total_training_tokens: 0,
                        recent_alerts: [],
                        top_performing_experiments: []
                    },

                    // Compute Calculator
                    compute: {
                        modelSize: '7B',
                        gpuType: 'A100-80G',
                        numGpus: 8,
                        contextLength: 4096,
                        trainingType: 'grpo',
                        loraEnabled: false,
                        loraRank: 8
                    },
                    computeResult: {
                        memory: {},
                        config: {},
                        warnings: [],
                        recommendations: [],
                        yaml: ''
                    },
                    computeLoading: false,
                    modelSizes: [],
                    gpuTypes: [],

                    // Jobs
                    jobs: [],
                    newJob: {
                        name: '',
                        algorithm: 'grpo',
                        model_path: '',
                        train_data_path: '',
                        num_gpus: 8,
                        gpu_type: 'A100-80G',
                        batch_size: 256,
                        learning_rate: '1e-6',
                        num_epochs: 3,
                        context_length: 4096,
                        lora_enabled: false,
                        lora_rank: 8,
                        description: ''
                    },

                    // Model Surgery
                    merge: {
                        baseModel: '',
                        finetuneModel: '',
                        method: 'slerp',
                        t: 0.7,
                        outputPath: ''
                    },
                    mergeLoading: false,
                    mergeResult: null,

                    checkpoint: {
                        experimentPath: '',
                        criteria: 'balanced',
                        customFormula: ''
                    },
                    checkpointLoading: false,
                    checkpointResult: null,

                    swa: {
                        checkpointPaths: '',
                        outputPath: ''
                    },
                    swaLoading: false,

                    // Monitoring
                    monitoring: {
                        selectedJobId: '',
                        metrics: {},
                        resources: { gpu_utilization: [], gpu_memory_used: [], gpu_memory_total: [] },
                        gradientData: { layers: [], steps: [], data: [] },
                        evaluations: [],
                        websocket: null
                    },

                    // Charts
                    lossChart: null,
                    rewardChart: null,
                    metricsHistory: { steps: [], losses: [], rewards: [] }
                }
            },
            computed: {
                filteredJobs() {
                    if (this.jobFilter === 'all') return this.jobs;
                    return this.jobs.filter(j => j.status === this.jobFilter);
                },
                runningJobs() {
                    return this.jobs.filter(j => ['running', 'queued', 'paused'].includes(j.status));
                }
            },
            methods: {
                // API Helper
                async api(endpoint, options = {}) {
                    try {
                        const response = await fetch(`${this.apiUrl}${endpoint}`, {
                            headers: { 'Content-Type': 'application/json' },
                            ...options
                        });
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'API Error');
                        }
                        return await response.json();
                    } catch (error) {
                        this.showToast(error.message, 'error');
                        throw error;
                    }
                },

                showToast(message, type = 'info') {
                    const id = Date.now();
                    this.toasts.push({ id, message, type });
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 5000);
                    this.$nextTick(() => lucide.createIcons());
                },

                formatTokens(n) {
                    if (!n) return '0';
                    if (n >= 1e12) return (n / 1e12).toFixed(1) + 'T';
                    if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
                    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
                    return n;
                },

                formatDate(date) {
                    if (!date) return 'N/A';
                    const d = new Date(date);
                    const now = new Date();
                    const diff = (now - d) / 1000;
                    if (diff < 60) return 'Just now';
                    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
                    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
                    return Math.floor(diff / 86400) + 'd ago';
                },

                getStatusClass(status) {
                    const classes = {
                        running: 'bg-emerald-500/20 text-emerald-400',
                        completed: 'bg-green-500/20 text-green-400',
                        failed: 'bg-red-500/20 text-red-400',
                        queued: 'bg-yellow-500/20 text-yellow-400',
                        paused: 'bg-gray-500/20 text-gray-400',
                        pending: 'bg-blue-500/20 text-blue-400',
                        cancelled: 'bg-gray-500/20 text-gray-400'
                    };
                    return classes[status] || 'bg-gray-500/20 text-gray-400';
                },

                getJobProgress(job) {
                    if (!job.total_steps || job.total_steps === 0) return 0;
                    return Math.round((job.current_step / job.total_steps) * 100);
                },

                getGpuMemory() {
                    const gpu = this.gpuTypes.find(g => g.id === this.compute.gpuType);
                    return gpu?.memory_gb || 80;
                },

                getHeatmapColor(value) {
                    const intensity = Math.min(value * 10, 1);
                    return `rgba(16, 185, 129, ${intensity})`;
                },

                // API Connection
                async checkApiConnection() {
                    try {
                        await this.api('/health');
                        this.apiConnected = true;
                        this.showToast('API connected successfully', 'success');
                        await this.loadInitialData();
                    } catch {
                        this.apiConnected = false;
                    }
                },

                async loadInitialData() {
                    await Promise.all([
                        this.loadGpuTypes(),
                        this.loadModelSizes(),
                        this.loadDashboard(),
                        this.loadJobs()
                    ]);
                },

                // Dashboard
                async loadDashboard() {
                    try {
                        this.loading = true;
                        this.dashboard = await this.api('/api/v1/monitoring/dashboard');
                    } catch (e) {
                        console.error('Failed to load dashboard:', e);
                    } finally {
                        this.loading = false;
                    }
                },

                // Compute Calculator
                async loadGpuTypes() {
                    try {
                        const data = await this.api('/api/v1/compute/gpu-types');
                        this.gpuTypes = data.gpu_types;
                    } catch (e) {
                        console.error('Failed to load GPU types:', e);
                    }
                },

                async loadModelSizes() {
                    try {
                        const data = await this.api('/api/v1/compute/model-sizes');
                        this.modelSizes = data.model_sizes;
                    } catch (e) {
                        console.error('Failed to load model sizes:', e);
                    }
                },

                async calculateCompute() {
                    this.computeLoading = true;
                    try {
                        const result = await this.api('/api/v1/compute/calculate', {
                            method: 'POST',
                            body: JSON.stringify({
                                model_size: this.compute.modelSize,
                                gpu_type: this.compute.gpuType,
                                num_gpus: this.compute.numGpus,
                                context_length: this.compute.contextLength,
                                training_type: this.compute.trainingType,
                                lora_enabled: this.compute.loraEnabled,
                                lora_rank: this.compute.loraRank
                            })
                        });

                        this.computeResult = {
                            memory: {
                                modelWeights: result.memory_estimate.model_weights_gb,
                                optimizer: result.memory_estimate.optimizer_states_gb,
                                gradients: result.memory_estimate.gradients_gb,
                                activations: result.memory_estimate.activations_gb,
                                perGpu: result.memory_estimate.per_gpu_gb,
                                utilization: result.memory_estimate.utilization_percent
                            },
                            config: {
                                zeroStage: result.zero_stage,
                                microBatchSize: result.config.actor.micro_batch_size_per_gpu,
                                gradientAccum: result.config.trainer.gradient_accumulation_steps,
                                globalBatchSize: result.config.computed.global_batch_size,
                                tensorParallel: result.config.rollout.tensor_parallel_size,
                                learningRate: result.config.actor.optim.lr
                            },
                            warnings: result.warnings,
                            recommendations: result.recommendations,
                            yaml: result.yaml
                        };

                        this.showToast('Configuration calculated successfully', 'success');
                    } catch (e) {
                        console.error('Failed to calculate config:', e);
                    } finally {
                        this.computeLoading = false;
                    }
                },

                exportYaml() {
                    const blob = new Blob([this.computeResult.yaml], { type: 'text/yaml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'verl_config.yaml';
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showToast('YAML config exported', 'success');
                },

                // Jobs
                async loadJobs() {
                    try {
                        this.loading = true;
                        const data = await this.api('/api/v1/jobs');
                        this.jobs = data.jobs;
                    } catch (e) {
                        console.error('Failed to load jobs:', e);
                    } finally {
                        this.loading = false;
                    }
                },

                async createJob() {
                    try {
                        const job = await this.api('/api/v1/jobs', {
                            method: 'POST',
                            body: JSON.stringify({
                                ...this.newJob,
                                learning_rate: parseFloat(this.newJob.learning_rate)
                            })
                        });
                        this.jobs.unshift(job);
                        this.showNewJobModal = false;
                        this.showToast(`Job "${job.name}" created successfully`, 'success');
                        this.resetNewJob();
                    } catch (e) {
                        console.error('Failed to create job:', e);
                    }
                },

                resetNewJob() {
                    this.newJob = {
                        name: '',
                        algorithm: 'grpo',
                        model_path: '',
                        train_data_path: '',
                        num_gpus: 8,
                        gpu_type: 'A100-80G',
                        batch_size: 256,
                        learning_rate: '1e-6',
                        num_epochs: 3,
                        context_length: 4096,
                        lora_enabled: false,
                        lora_rank: 8,
                        description: ''
                    };
                },

                async startJob(jobId) {
                    try {
                        await this.api(`/api/v1/jobs/${jobId}/start`, { method: 'POST' });
                        await this.loadJobs();
                        this.showToast('Job started', 'success');
                    } catch (e) {
                        console.error('Failed to start job:', e);
                    }
                },

                async pauseJob(jobId) {
                    try {
                        await this.api(`/api/v1/jobs/${jobId}/pause`, { method: 'POST' });
                        await this.loadJobs();
                        this.showToast('Job paused', 'success');
                    } catch (e) {
                        console.error('Failed to pause job:', e);
                    }
                },

                async resumeJob(jobId) {
                    try {
                        await this.api(`/api/v1/jobs/${jobId}/resume`, { method: 'POST' });
                        await this.loadJobs();
                        this.showToast('Job resumed', 'success');
                    } catch (e) {
                        console.error('Failed to resume job:', e);
                    }
                },

                async stopJob(jobId) {
                    try {
                        await this.api(`/api/v1/jobs/${jobId}/stop`, { method: 'POST' });
                        await this.loadJobs();
                        this.showToast('Job stopped', 'success');
                    } catch (e) {
                        console.error('Failed to stop job:', e);
                    }
                },

                async deleteJob(jobId) {
                    if (!confirm('Are you sure you want to delete this job?')) return;
                    try {
                        await this.api(`/api/v1/jobs/${jobId}`, { method: 'DELETE' });
                        this.jobs = this.jobs.filter(j => j.id !== jobId);
                        this.showToast('Job deleted', 'success');
                    } catch (e) {
                        console.error('Failed to delete job:', e);
                    }
                },

                viewJobDetails(job) {
                    this.monitoring.selectedJobId = job.id;
                    this.currentPage = 'monitoring';
                    this.loadJobMonitoring();
                },

                // Model Surgery
                async mergeModels() {
                    this.mergeLoading = true;
                    try {
                        const result = await this.api('/api/v1/surgery/merge', {
                            method: 'POST',
                            body: JSON.stringify({
                                method: this.merge.method,
                                models: [this.merge.baseModel, this.merge.finetuneModel],
                                interpolation_t: this.merge.t,
                                output_path: this.merge.outputPath || null
                            })
                        });
                        this.mergeResult = result;
                        if (result.success) {
                            this.showToast('Models merged successfully', 'success');
                        }
                    } catch (e) {
                        console.error('Failed to merge models:', e);
                    } finally {
                        this.mergeLoading = false;
                    }
                },

                async selectCheckpoint() {
                    this.checkpointLoading = true;
                    try {
                        const result = await this.api('/api/v1/surgery/checkpoint/select', {
                            method: 'POST',
                            body: JSON.stringify({
                                experiment_path: this.checkpoint.experimentPath,
                                criteria: this.checkpoint.criteria,
                                custom_formula: this.checkpoint.criteria === 'custom' ? this.checkpoint.customFormula : null
                            })
                        });
                        this.checkpointResult = result;
                        if (result.success) {
                            this.showToast('Best checkpoint found', 'success');
                        }
                    } catch (e) {
                        console.error('Failed to select checkpoint:', e);
                    } finally {
                        this.checkpointLoading = false;
                    }
                },

                async performSWA() {
                    this.swaLoading = true;
                    try {
                        const paths = this.swa.checkpointPaths.split('\n').filter(p => p.trim());
                        const result = await this.api('/api/v1/surgery/swa', {
                            method: 'POST',
                            body: JSON.stringify({
                                checkpoint_paths: paths,
                                output_path: this.swa.outputPath || null
                            })
                        });
                        if (result.success) {
                            this.showToast(`SWA completed: ${result.num_checkpoints_averaged} checkpoints averaged`, 'success');
                        } else {
                            this.showToast(result.message, 'error');
                        }
                    } catch (e) {
                        console.error('Failed to perform SWA:', e);
                    } finally {
                        this.swaLoading = false;
                    }
                },

                // Monitoring
                async loadJobMonitoring() {
                    if (!this.monitoring.selectedJobId) return;

                    try {
                        const [resources, gradients, evaluations] = await Promise.all([
                            this.api(`/api/v1/monitoring/${this.monitoring.selectedJobId}/resources`),
                            this.api(`/api/v1/monitoring/${this.monitoring.selectedJobId}/gradient-heatmap`),
                            this.api(`/api/v1/monitoring/${this.monitoring.selectedJobId}/evaluations`)
                        ]);

                        this.monitoring.resources = resources.usage;
                        this.monitoring.gradientData = gradients;
                        this.monitoring.evaluations = evaluations.results;

                        this.$nextTick(() => this.initCharts());
                        this.startWebSocket();
                    } catch (e) {
                        console.error('Failed to load monitoring data:', e);
                    }
                },

                startMonitoring() {
                    if (this.monitoring.selectedJobId) {
                        this.loadJobMonitoring();
                    }
                },

                startWebSocket() {
                    if (this.monitoring.websocket) {
                        this.monitoring.websocket.close();
                    }

                    const wsUrl = this.apiUrl.replace('http', 'ws');
                    try {
                        this.monitoring.websocket = new WebSocket(
                            `${wsUrl}/api/v1/monitoring/${this.monitoring.selectedJobId}/live`
                        );

                        this.monitoring.websocket.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            this.monitoring.metrics = data;
                            this.updateCharts(data);
                        };

                        this.monitoring.websocket.onerror = () => {
                            console.log('WebSocket error - using polling fallback');
                        };
                    } catch (e) {
                        console.log('WebSocket not available');
                    }
                },

                initCharts() {
                    const lossCtx = document.getElementById('lossChart');
                    const rewardCtx = document.getElementById('rewardChart');

                    if (this.lossChart) this.lossChart.destroy();
                    if (this.rewardChart) this.rewardChart.destroy();

                    const chartOptions = {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                        }
                    };

                    if (lossCtx) {
                        this.lossChart = new Chart(lossCtx, {
                            type: 'line',
                            data: {
                                labels: this.metricsHistory.steps,
                                datasets: [{
                                    label: 'Policy Loss',
                                    data: this.metricsHistory.losses,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: chartOptions
                        });
                    }

                    if (rewardCtx) {
                        this.rewardChart = new Chart(rewardCtx, {
                            type: 'line',
                            data: {
                                labels: this.metricsHistory.steps,
                                datasets: [{
                                    label: 'Mean Reward',
                                    data: this.metricsHistory.rewards,
                                    borderColor: '#06b6d4',
                                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: chartOptions
                        });
                    }
                },

                updateCharts(data) {
                    if (data.step !== undefined) {
                        this.metricsHistory.steps.push(data.step);
                        this.metricsHistory.losses.push(data.policy_loss || 0);
                        this.metricsHistory.rewards.push(data.reward_mean || 0);

                        // Keep last 50 points
                        if (this.metricsHistory.steps.length > 50) {
                            this.metricsHistory.steps.shift();
                            this.metricsHistory.losses.shift();
                            this.metricsHistory.rewards.shift();
                        }

                        if (this.lossChart) {
                            this.lossChart.data.labels = this.metricsHistory.steps;
                            this.lossChart.data.datasets[0].data = this.metricsHistory.losses;
                            this.lossChart.update('none');
                        }

                        if (this.rewardChart) {
                            this.rewardChart.data.labels = this.metricsHistory.steps;
                            this.rewardChart.data.datasets[0].data = this.metricsHistory.rewards;
                            this.rewardChart.update('none');
                        }
                    }
                }
            },
            mounted() {
                lucide.createIcons();
                this.checkApiConnection();
            },
            updated() {
                this.$nextTick(() => lucide.createIcons());
            },
            beforeUnmount() {
                if (this.monitoring.websocket) {
                    this.monitoring.websocket.close();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
