# å¤§æ¨¡å‹è®­ç»ƒå¹³å°è®¾è®¡æ–¹æ¡ˆ

> åŸºäº verl æ¡†æ¶æ„å»ºçš„ç«¯åˆ°ç«¯å¤§æ¨¡å‹è®­ç»ƒå¹³å°

## ä¸€ã€å¹³å°æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Web UI (Frontend)                            â”‚
â”‚   React/Vue + ECharts/Plotly + WebSocketå®æ—¶æ›´æ–°                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Gateway (FastAPI)                          â”‚
â”‚   è®­ç»ƒä»»åŠ¡ç®¡ç† / æ•°æ®é›†ç®¡ç† / ç›‘æ§API / è¯„ä¼°API / è¿­ä»£ç®¡ç†            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼               â–¼               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ•°æ®é›†  â”‚   â”‚ ç®—åŠ›è®¡ç®—å™¨ â”‚   â”‚ è®­ç»ƒè°ƒåº¦   â”‚   â”‚ æ¨¡å‹æ‰‹æœ¯å° â”‚   â”‚  è¯„ä¼°æ¨¡å—  â”‚
â”‚æ¨¡å—    â”‚   â”‚ Compute    â”‚   â”‚ æ¨¡å—       â”‚   â”‚ Model      â”‚   â”‚            â”‚
â”‚        â”‚   â”‚ Calculator â”‚   â”‚            â”‚   â”‚ Surgery    â”‚   â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚               â”‚               â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç›‘æ§ä¸æ—¥å¿—ç³»ç»Ÿ                               â”‚
â”‚   Prometheus + Grafana + TensorBoard + è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å­˜å‚¨å±‚                                      â”‚
â”‚   PostgreSQL(å…ƒæ•°æ®) + Redis(ç¼“å­˜/é˜Ÿåˆ—) + S3/MinIO(æ¨¡å‹/æ•°æ®)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡

### æ¨¡å—1ï¼šæ•°æ®é›†æ„é€ ä¸ç®¡ç†

#### 1.1 æ•°æ®é›†æ„é€ æµç¨‹

```
åŸå§‹æ•°æ® â†’ æ¸…æ´—è¿‡æ»¤ â†’ æ ¼å¼è½¬æ¢ â†’ è´¨é‡è¯„ä¼° â†’ ç‰ˆæœ¬åŒ–å­˜å‚¨
```

#### 1.2 æ”¯æŒçš„æ•°æ®æ ¼å¼

| ä»»åŠ¡ç±»å‹ | æ•°æ®æ ¼å¼ | ç¤ºä¾‹ |
|---------|---------|------|
| SFT | instruction-response | `{"instruction": "...", "response": "..."}` |
| RLHF/PPO | prompt + reward | `{"prompt": "...", "chosen": "...", "rejected": "..."}` |
| GRPO | prompt + verifiable answer | `{"prompt": "...", "answer": "...", "reward_func": "math"}` |

#### 1.3 æ•°æ®é›†ç®¡ç†åŠŸèƒ½

- **ç‰ˆæœ¬æ§åˆ¶**: åŸºäºGit-likeçš„ç‰ˆæœ¬ç®¡ç†ï¼Œæ”¯æŒå›æ»š
- **æ•°æ®è¡€ç¼˜**: è¿½è¸ªæ•°æ®æ¥æºå’Œå¤„ç†é“¾è·¯
- **è´¨é‡æ£€æµ‹**:
  - é‡å¤æ£€æµ‹ï¼ˆMinHash/SimHashï¼‰
  - æ¯’æ€§æ£€æµ‹ï¼ˆPerspective APIé›†æˆï¼‰
  - æ ¼å¼æ ¡éªŒ
- **æ™ºèƒ½åˆ‡åˆ†**: åŸºäºè¯­ä¹‰çš„æ™ºèƒ½åˆ‡åˆ†ï¼ˆä¸åªæ˜¯æŒ‰tokenæ•°ï¼‰

#### 1.4 æ•°æ®é¢„å¤„ç†Pipeline

```python
# é¢„å¤„ç†é…ç½®ç¤ºä¾‹ç»“æ„
{
    "pipeline": [
        {"step": "deduplicate", "method": "minhash", "threshold": 0.8},
        {"step": "filter_length", "min": 10, "max": 4096},
        {"step": "tokenize", "tokenizer": "Qwen/Qwen2.5-7B"},
        {"step": "pack_sequences", "max_length": 4096},  # verlæ”¯æŒçš„åºåˆ—æ‰“åŒ…
        {"step": "split", "train": 0.9, "val": 0.05, "test": 0.05}
    ]
}
```

---

### æ¨¡å—2ï¼šè®­ç»ƒè¿‡ç¨‹ç›‘æ§ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰

#### 2.1 å®æ—¶ç›‘æ§æŒ‡æ ‡ä½“ç³»

##### æŸå¤±ç›¸å…³æŒ‡æ ‡

| æŒ‡æ ‡åç§° | æè¿° | ç›‘æ§æ„ä¹‰ |
|---------|------|---------|
| `policy_loss` | ç­–ç•¥æŸå¤± | RLè®­ç»ƒæ ¸å¿ƒæŒ‡æ ‡ |
| `value_loss` | ä»·å€¼å‡½æ•°æŸå¤± | PPOç‰¹æœ‰ï¼Œè¡¡é‡criticè´¨é‡ |
| `entropy_loss` | ç†µæŸå¤± | æ¢ç´¢èƒ½åŠ›ï¼Œè¿‡ä½è¯´æ˜ç­–ç•¥åç¼© |
| `kl_divergence` | KLæ•£åº¦ | ä¸å‚è€ƒæ¨¡å‹çš„åç¦»ç¨‹åº¦ |
| `clip_fraction` | PPOè£å‰ªæ¯”ä¾‹ | è¶…è¿‡0.2éœ€è¦è°ƒæ•´ |
| `approx_kl` | è¿‘ä¼¼KL | ç”¨äºæ—©åœåˆ¤æ–­ |
| `reward_mean/std` | å¥–åŠ±å‡å€¼/æ ‡å‡†å·® | å¥–åŠ±åˆ†å¸ƒå¥åº·åº¦ |
| `advantage_mean` | ä¼˜åŠ¿å‡½æ•°å‡å€¼ | åº”æ¥è¿‘0 |

##### æ¢¯åº¦ç›¸å…³æŒ‡æ ‡

| æŒ‡æ ‡åç§° | æè¿° | ç›‘æ§æ„ä¹‰ |
|---------|------|---------|
| `grad_norm` | æ¢¯åº¦èŒƒæ•° | æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±æ£€æµ‹ |
| `grad_norm_per_layer` | åˆ†å±‚æ¢¯åº¦èŒƒæ•° | å®šä½é—®é¢˜å±‚ |
| `grad_var` | æ¢¯åº¦æ–¹å·® | è®­ç»ƒç¨³å®šæ€§ |
| `grad_histogram` | æ¢¯åº¦ç›´æ–¹å›¾ | åˆ†å¸ƒå¼‚å¸¸æ£€æµ‹ |
| `weight_norm` | æƒé‡èŒƒæ•° | æ¨¡å‹é€€åŒ–æ£€æµ‹ |
| `weight_update_ratio` | æƒé‡æ›´æ–°æ¯” | å­¦ä¹ ç‡æ˜¯å¦åˆé€‚ |

##### ç”Ÿæˆè´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | æè¿° | ç›‘æ§æ„ä¹‰ |
|---------|------|---------|
| `response_length` | å“åº”é•¿åº¦åˆ†å¸ƒ | é˜²æ­¢é•¿åº¦hack |
| `diversity_score` | å“åº”å¤šæ ·æ€§ | n-gramé‡å¤ç‡ |
| `generation_speed` | ç”Ÿæˆé€Ÿåº¦ | tokens/s |
| `reward_per_length` | é•¿åº¦å½’ä¸€åŒ–å¥–åŠ± | GRPOç‰¹åˆ«éœ€è¦ |

#### 2.2 æ¢¯åº¦å˜åŒ–çƒ­åŠ›å›¾è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Gradient Heatmap (Layer Ã— Time)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 0  â–‘â–‘â–‘â–’â–’â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚  Layer 1  â–‘â–‘â–’â–’â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚  Layer 2  â–‘â–’â–’â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚  ...      ...                                       â”‚
â”‚  Layer N  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step:    0    500   1000  1500  2000  2500  3000  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é¢œè‰²: â–‘(å°) â†’ â–’ â†’ â–“ â†’ â–ˆ(å¤§)
```

**é‡‡é›†ç­–ç•¥**:
- æ¯Næ­¥é‡‡é›†ä¸€æ¬¡å®Œæ•´æ¢¯åº¦ï¼ˆNå¯é…ç½®ï¼Œé»˜è®¤100ï¼‰
- åˆ†å±‚èšåˆï¼šè®°å½•æ¯å±‚çš„ mean, std, max, min, percentiles
- æ”¯æŒæŒ‰æ³¨æ„åŠ›/FFN/åµŒå…¥ç­‰æ¨¡å—åˆ†ç»„

#### 2.3 Checkpointè¯„ä¼°ç›‘æ§

```
Checkpoint Timeline
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚           â”‚           â”‚           â”‚           â”‚
   ckpt-0     ckpt-1000   ckpt-2000   ckpt-3000   ckpt-4000
    â”‚           â”‚           â”‚           â”‚           â”‚
    â–¼           â–¼           â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚GSM8K  â”‚  â”‚GSM8K  â”‚  â”‚GSM8K  â”‚  â”‚GSM8K  â”‚  â”‚GSM8K  â”‚
â”‚45.2%  â”‚  â”‚52.3%  â”‚  â”‚58.1%  â”‚  â”‚61.5%  â”‚  â”‚63.2%  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
â”‚MATH   â”‚  â”‚MATH   â”‚  â”‚MATH   â”‚  â”‚MATH   â”‚  â”‚MATH   â”‚
â”‚12.1%  â”‚  â”‚15.8%  â”‚  â”‚19.2%  â”‚  â”‚22.5%  â”‚  â”‚24.1%  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªåŠ¨è¯„ä¼°æœºåˆ¶**:
- é…ç½®è¯„ä¼°é—´éš”ï¼ˆæ¯Næ­¥æˆ–æ¯Nå°æ—¶ï¼‰
- å¼‚æ­¥è¯„ä¼°ï¼šä¸é˜»å¡è®­ç»ƒä¸»æµç¨‹
- è¯„ä¼°ç»“æœè‡ªåŠ¨å†™å…¥æ•°æ®åº“ï¼Œå‰ç«¯å®æ—¶å±•ç¤º

#### 2.4 é«˜çº§ç›‘æ§åŠŸèƒ½

##### å¼‚å¸¸æ£€æµ‹ä¸å‘Šè­¦

```python
alert_rules = {
    "grad_explosion": {"condition": "grad_norm > 100", "action": "pause_training"},
    "reward_collapse": {"condition": "reward_std < 0.01 for 500 steps", "action": "notify"},
    "kl_divergence_high": {"condition": "kl > 0.2", "action": "reduce_lr"},
    "loss_nan": {"condition": "isnan(loss)", "action": "rollback_checkpoint"},
    "entropy_collapse": {"condition": "entropy < 0.1", "action": "increase_entropy_coef"}
}
```

##### èµ„æºç›‘æ§

- GPUåˆ©ç”¨ç‡ã€æ˜¾å­˜å ç”¨
- ç½‘ç»œå¸¦å®½ï¼ˆåˆ†å¸ƒå¼è®­ç»ƒï¼‰
- ç£ç›˜I/Oï¼ˆæ•°æ®åŠ è½½ç“¶é¢ˆæ£€æµ‹ï¼‰
- Rayé›†ç¾¤çŠ¶æ€

---

### æ¨¡å—3ï¼šè®­ç»ƒä»»åŠ¡ç®¡ç†

#### 3.1 ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º â†’ æ’é˜Ÿ â†’ èµ„æºåˆ†é… â†’ è¿è¡Œä¸­ â†’ (æš‚åœ/æ¢å¤) â†’ å®Œæˆ/å¤±è´¥
```

#### 3.2 ä¸verlçš„é›†æˆæ–¹å¼

```python
# ä»»åŠ¡é…ç½®æ¨¡æ¿ï¼ˆå¯¹æ¥verlçš„Hydraé…ç½®ï¼‰
{
    "job_name": "qwen2.5-7b-grpo-math",
    "base_config": "grpo_trainer",  # verlé¢„ç½®é…ç½®
    "overrides": {
        "model.path": "Qwen/Qwen2.5-7B",
        "data.train_files": ["s3://datasets/math_v2/train.parquet"],
        "algorithm.kl_coef": 0.02,
        "trainer.total_epochs": 3,
        "rollout.n": 8,  # GRPOé‡‡æ ·æ•°
        "actor.optim.lr": 1e-6,
        # ... æ›´å¤šè¦†ç›–é…ç½®
    },
    "resources": {
        "gpus": 8,
        "gpu_type": "A100-80G"
    },
    "monitoring": {
        "checkpoint_interval": 500,
        "eval_interval": 1000,
        "eval_datasets": ["gsm8k", "math500"]
    }
}
```

#### 3.3 ä»»åŠ¡é˜Ÿåˆ—ä¸è°ƒåº¦

- ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆæ”¯æŒæŠ¢å ï¼‰
- èµ„æºæ„ŸçŸ¥è°ƒåº¦
- æ–­ç‚¹ç»­è®­æ”¯æŒï¼ˆåŸºäºverlçš„checkpointæœºåˆ¶ï¼‰

---

### æ¨¡å—4ï¼šè¯„ä¼°ç³»ç»Ÿ

#### 4.1 å†…ç½®Benchmark

| Benchmark | ç±»å‹ | è¯„ä¼°æ–¹å¼ |
|-----------|------|---------|
| GSM8K | æ•°å­¦æ¨ç† | ç²¾ç¡®åŒ¹é… |
| MATH | é«˜ç­‰æ•°å­¦ | ç¬¦å·ç­‰ä»·éªŒè¯ |
| HumanEval | ä»£ç ç”Ÿæˆ | æ‰§è¡Œé€šè¿‡ç‡ |
| MBPP | ä»£ç ç”Ÿæˆ | æ‰§è¡Œé€šè¿‡ç‡ |
| MMLU | å¤šå­¦ç§‘ | é€‰æ‹©é¢˜å‡†ç¡®ç‡ |
| ARC | å¸¸è¯†æ¨ç† | é€‰æ‹©é¢˜å‡†ç¡®ç‡ |
| AIME | ç«èµ›æ•°å­¦ | ç²¾ç¡®åŒ¹é…ï¼ˆverlå·²æ”¯æŒï¼‰ |

#### 4.2 è¯„ä¼°æµç¨‹

```
Checkpoint â†’ æ¨¡å‹åŠ è½½ â†’ æ¨ç†ç”Ÿæˆ â†’ ç­”æ¡ˆæå– â†’ è¯„åˆ† â†’ ç»“æœå­˜å‚¨
                              â†“
                      (å¯é€‰) å¥–åŠ±æ¨¡å‹æ‰“åˆ†
                              â†“
                      (å¯é€‰) äººå·¥è¯„ä¼°é˜Ÿåˆ—
```

#### 4.3 è¯„ä¼°æŠ¥å‘Š

- è‡ªåŠ¨ç”Ÿæˆè¯„ä¼°æŠ¥å‘Šï¼ˆMarkdown/PDFï¼‰
- ä¸å†å²ç‰ˆæœ¬å¯¹æ¯”åˆ†æ
- èƒ½åŠ›é›·è¾¾å›¾

---

### æ¨¡å—5ï¼šè¿­ä»£ç®¡ç†

#### 5.1 å®éªŒè¿½è¸ª

```
Experiment: qwen2.5-7b-math-rl
â”œâ”€â”€ v1.0 (baseline SFT)
â”‚   â”œâ”€â”€ config.yaml
â”‚   â”œâ”€â”€ metrics/
â”‚   â””â”€â”€ checkpoints/
â”œâ”€â”€ v1.1 (GRPO, kl=0.02)
â”‚   â”œâ”€â”€ config.yaml (diff from v1.0)
â”‚   â”œâ”€â”€ metrics/
â”‚   â””â”€â”€ checkpoints/
â”œâ”€â”€ v1.2 (GRPO, kl=0.01, more data)
â”‚   â””â”€â”€ ...
â””â”€â”€ comparison_report.html
```

#### 5.2 é…ç½®diffå¯è§†åŒ–

- YAMLé…ç½®å¯¹æ¯”
- è‡ªåŠ¨é«˜äº®å˜æ›´å‚æ•°
- å‚æ•°å½±å“åˆ†æï¼ˆA/Bæµ‹è¯•ç»Ÿè®¡æ˜¾è‘—æ€§ï¼‰

#### 5.3 è¿­ä»£å·¥ä½œæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†æä¸Šè½®â”‚â”€â”€â”€â–¶â”‚ è°ƒæ•´é…ç½®â”‚â”€â”€â”€â–¶â”‚ å¯åŠ¨è®­ç»ƒâ”‚â”€â”€â”€â–¶â”‚ è¯„ä¼°å¯¹æ¯”â”‚
â”‚ ç»“æœ    â”‚    â”‚ /æ•°æ®   â”‚    â”‚         â”‚    â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                                            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ¨¡å—6ï¼šç®—åŠ›è®¡ç®—å™¨ (Compute Calculator)

> è§£å†³"æˆ‘åº”è¯¥å¼€å¤šå°‘ GPUï¼Œè®¾å¤šå¤§ Batch Size"çš„é—®é¢˜

#### 6.1 æ ¸å¿ƒåŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®—åŠ›è®¡ç®—å™¨ é…ç½®å‘å¯¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“Š è¾“å…¥å‚æ•°                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ¨¡å‹å¤§å°:    [7B â–¼]     ä¸Šä¸‹æ–‡é•¿åº¦:  [4096 â–¼]            â”‚   â”‚
â”‚  â”‚ GPUç±»å‹:     [A100-80G â–¼]   å¯ç”¨GPUæ•°:  [8    ]          â”‚   â”‚
â”‚  â”‚ è®­ç»ƒç±»å‹:    [GRPO â–¼]    æ˜¯å¦ä½¿ç”¨LoRA: [âœ“]               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ğŸ¯ æ¨èé…ç½®                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ZeRO Stage:        ZeRO-2 (æ¨è)                        â”‚   â”‚
â”‚  â”‚ Tensor Parallel:   1                                    â”‚   â”‚
â”‚  â”‚ Micro Batch Size:  4                                    â”‚   â”‚
â”‚  â”‚ Gradient Accum:    8                                    â”‚   â”‚
â”‚  â”‚ Global Batch Size: 256                                  â”‚   â”‚
â”‚  â”‚ é¢„ä¼°æ˜¾å­˜å ç”¨:       65.2 GB / 80 GB (81.5%)              â”‚   â”‚
â”‚  â”‚ é¢„ä¼°ååé‡:         ~1200 tokens/s                       â”‚   â”‚
â”‚  â”‚ CPU Offload:       å…³é—­                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ é£é™©æç¤º: å½“å‰é…ç½®æ˜¾å­˜ä½™é‡è¾ƒå°ï¼Œå»ºè®®é™ä½ micro_batch_size    â”‚
â”‚                                                                 â”‚
â”‚  [åº”ç”¨é…ç½®]  [å¯¼å‡ºYAML]  [é«˜çº§è®¾ç½®]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.2 æ˜¾å­˜ä¼°ç®—æ¨¡å‹

##### æ˜¾å­˜ç»„æˆåˆ†æ

```python
# æ˜¾å­˜ä¼°ç®—å…¬å¼
def estimate_memory(model_params_B, seq_len, batch_size, precision, zero_stage):
    """
    æ˜¾å­˜ = æ¨¡å‹æƒé‡ + ä¼˜åŒ–å™¨çŠ¶æ€ + æ¢¯åº¦ + æ¿€æ´»å€¼ + KV Cache
    """
    bytes_per_param = {"fp32": 4, "fp16": 2, "bf16": 2, "fp8": 1}[precision]

    # 1. æ¨¡å‹æƒé‡
    model_memory = model_params_B * 1e9 * bytes_per_param

    # 2. ä¼˜åŒ–å™¨çŠ¶æ€ (AdamW: 2ä¸ªåŠ¨é‡ + master weights)
    if zero_stage == 0:
        optimizer_memory = model_params_B * 1e9 * 12  # fp32 master + 2 momentum
    elif zero_stage == 1:
        optimizer_memory = model_params_B * 1e9 * 12 / num_gpus
    elif zero_stage == 2:
        optimizer_memory = model_params_B * 1e9 * 12 / num_gpus
    elif zero_stage == 3:
        optimizer_memory = model_params_B * 1e9 * 12 / num_gpus
        model_memory = model_memory / num_gpus

    # 3. æ¢¯åº¦
    gradient_memory = model_params_B * 1e9 * bytes_per_param
    if zero_stage >= 2:
        gradient_memory = gradient_memory / num_gpus

    # 4. æ¿€æ´»å€¼ (ä¸åºåˆ—é•¿åº¦å’Œbatch_sizeç›¸å…³)
    # è¿‘ä¼¼å…¬å¼: hidden_size * num_layers * seq_len * batch_size * factor
    activation_memory = estimate_activation(model_params_B, seq_len, batch_size)

    # 5. KV Cache (æ¨ç†æ—¶)
    kv_cache = 2 * num_layers * hidden_size * seq_len * batch_size * bytes_per_param

    return {
        "model": model_memory,
        "optimizer": optimizer_memory,
        "gradient": gradient_memory,
        "activation": activation_memory,
        "kv_cache": kv_cache,
        "total": sum([model_memory, optimizer_memory, gradient_memory, activation_memory])
    }
```

##### æ¨¡å‹è§„æ¨¡ä¸æ˜¾å­˜å‚è€ƒè¡¨

| æ¨¡å‹å¤§å° | å‚æ•°é‡ | FP16æƒé‡ | ZeRO-2 (8å¡) | ZeRO-3 (8å¡) | æ¨èé…ç½® |
|---------|-------|---------|-------------|-------------|---------|
| 0.5B | 0.5B | 1 GB | ~8 GB/å¡ | ~4 GB/å¡ | å•å¡A100 |
| 1.5B | 1.5B | 3 GB | ~12 GB/å¡ | ~6 GB/å¡ | å•å¡A100 |
| 7B | 7B | 14 GB | ~25 GB/å¡ | ~12 GB/å¡ | 2-4å¡ A100 |
| 14B | 14B | 28 GB | ~45 GB/å¡ | ~20 GB/å¡ | 4-8å¡ A100 |
| 32B | 32B | 64 GB | ~85 GB/å¡ | ~35 GB/å¡ | 8å¡ A100 |
| 72B | 72B | 144 GB | OOM | ~60 GB/å¡ | 16å¡+ / TP |

#### 6.3 ZeRO Stage é€‰æ‹©ç­–ç•¥

```
å†³ç­–æ ‘:
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ æ¨¡å‹èƒ½å¦å•å¡æ”¾ä¸‹? â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                              â–¼
           èƒ½æ”¾ä¸‹                          æ”¾ä¸ä¸‹
              â”‚                              â”‚
              â–¼                              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ä½¿ç”¨ ZeRO-0/1  â”‚            â”‚ æ¨¡å‹>æ˜¾å­˜*GPUæ•°?â”‚
     â”‚ æœ€å¤§åŒ–ååé‡   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â–¼                      â–¼
                               æ˜¯                     å¦
                                â”‚                      â”‚
                                â–¼                      â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ ZeRO-3 + Offload â”‚   â”‚    ZeRO-2/3      â”‚
                     â”‚ æˆ– Tensor Parallelâ”‚   â”‚  æ ¹æ®é€šä¿¡å¸¦å®½é€‰æ‹© â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ZeRO Stage å¯¹æ¯”

| ç‰¹æ€§ | ZeRO-0 | ZeRO-1 | ZeRO-2 | ZeRO-3 |
|-----|--------|--------|--------|--------|
| ä¼˜åŒ–å™¨çŠ¶æ€åˆ†ç‰‡ | âŒ | âœ… | âœ… | âœ… |
| æ¢¯åº¦åˆ†ç‰‡ | âŒ | âŒ | âœ… | âœ… |
| æ¨¡å‹å‚æ•°åˆ†ç‰‡ | âŒ | âŒ | âŒ | âœ… |
| æ˜¾å­˜èŠ‚çœ | 1x | 4x | 8x | 64x+ |
| é€šä¿¡å¼€é”€ | ä½ | ä½ | ä¸­ | é«˜ |
| é€‚ç”¨åœºæ™¯ | å°æ¨¡å‹ | ä¸­æ¨¡å‹ | å¤§æ¨¡å‹ | è¶…å¤§æ¨¡å‹ |

#### 6.4 åºåˆ—é•¿åº¦å¯¹æ˜¾å­˜çš„å½±å“

```
æ˜¾å­˜å¢é•¿æ›²çº¿ (7Bæ¨¡å‹, A100-80G, batch_size=4)

æ˜¾å­˜(GB)
80 â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ OOM â”€â”€â”€
    â”‚                                    â•±
70 â”€â”¤                                 â•±
    â”‚                              â•±
60 â”€â”¤                           â•±
    â”‚                        â•±
50 â”€â”¤                     â•±  â† æ¿€æ´»å€¼ä¸»å¯¼
    â”‚                  â•±
40 â”€â”¤               â•±
    â”‚            â•±
30 â”€â”¤        â•±
    â”‚     â•±  â† æ¨¡å‹æƒé‡ + ä¼˜åŒ–å™¨ (å›ºå®šå¼€é”€)
20 â”€â”¤â”€â”€â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚
10 â”€â”¤
    â”‚
 0 â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€
         1K   2K   4K   8K  16K  32K  64K 128K åºåˆ—é•¿åº¦
```

**å…³é”®æ´å¯Ÿ**:
- çŸ­åºåˆ— (<4K): æ˜¾å­˜ä¸»è¦è¢«æ¨¡å‹æƒé‡å’Œä¼˜åŒ–å™¨å ç”¨
- é•¿åºåˆ— (>8K): æ¿€æ´»å€¼æˆä¸ºä¸»è¦æ˜¾å­˜æ¶ˆè€—
- è¶…é•¿åºåˆ—: éœ€è¦æ¿€æ´»æ£€æŸ¥ç‚¹ (Activation Checkpointing) æˆ–åºåˆ—å¹¶è¡Œ

#### 6.5 LoRA æ˜¾å­˜ä¼˜åŒ–

```python
# LoRA æ˜¾å­˜ä¼°ç®—
def estimate_lora_memory(base_model_params, lora_rank, lora_alpha, target_modules):
    """
    LoRA åªè®­ç»ƒä½ç§©çŸ©é˜µï¼Œå¤§å¹…å‡å°‘å¯è®­ç»ƒå‚æ•°
    """
    # åŸºåº§æ¨¡å‹å†»ç»“ï¼Œåªéœ€å­˜å‚¨æƒé‡
    frozen_memory = base_model_params * 2  # FP16

    # LoRA å‚æ•°: æ¯ä¸ªç›®æ ‡æ¨¡å— 2 * (d * r) å‚æ•°
    lora_params = sum([
        2 * hidden_size * lora_rank
        for module in target_modules
    ])

    # LoRA ä¼˜åŒ–å™¨çŠ¶æ€ (åªéœ€ä¸º LoRA å‚æ•°ç»´æŠ¤)
    lora_optimizer = lora_params * 12  # AdamW fp32

    return {
        "frozen_model": frozen_memory,
        "lora_params": lora_params * 2,
        "lora_optimizer": lora_optimizer,
        "savings": f"{(1 - lora_params/base_model_params)*100:.1f}% å‚æ•°é‡å‡å°‘"
    }
```

| é…ç½® | 7B å…¨å‚æ•° | 7B LoRA r=8 | 7B LoRA r=64 |
|------|----------|-------------|--------------|
| å¯è®­ç»ƒå‚æ•° | 7B | ~4M | ~32M |
| ä¼˜åŒ–å™¨æ˜¾å­˜ | 84 GB | ~48 MB | ~384 MB |
| æ€»æ˜¾å­˜éœ€æ±‚ | ~65 GB | ~18 GB | ~22 GB |

#### 6.6 verl é…ç½®è‡ªåŠ¨ç”Ÿæˆ

```python
def generate_verl_compute_config(
    model_size: str,      # "7B", "14B", "72B"
    gpu_type: str,        # "A100-80G", "A100-40G", "H100"
    num_gpus: int,
    context_length: int,
    training_type: str,   # "ppo", "grpo", "sft"
    use_lora: bool = False
) -> dict:
    """æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆæœ€ä¼˜ verl é…ç½®"""

    # 1. ä¼°ç®—æ˜¾å­˜éœ€æ±‚
    memory_estimate = estimate_memory(...)

    # 2. é€‰æ‹© ZeRO Stage
    zero_stage = select_zero_stage(memory_estimate, num_gpus, gpu_memory)

    # 3. è®¡ç®—æœ€å¤§ batch size
    available_memory = gpu_memory - memory_estimate["fixed"]
    max_micro_batch = calculate_max_batch(available_memory, context_length)

    # 4. ç”Ÿæˆé…ç½®
    config = {
        "actor": {
            "strategy": "fsdp",  # æˆ– megatron
            "fsdp_config": {
                "sharding_strategy": f"SHARD_GRAD_OP" if zero_stage == 2 else "FULL_SHARD",
                "cpu_offload": memory_estimate["total"] > gpu_memory * 0.9,
            },
            "micro_batch_size": max_micro_batch,
            "micro_batch_size_per_gpu": max_micro_batch // num_gpus,
        },
        "rollout": {
            "tensor_parallel_size": 1 if model_size <= "14B" else 2,
            "gpu_memory_utilization": 0.85,
        },
        "trainer": {
            "gradient_accumulation_steps": 256 // (max_micro_batch * num_gpus),
        }
    }

    # 5. æ·»åŠ è­¦å‘Šå’Œå»ºè®®
    config["_warnings"] = generate_warnings(memory_estimate, config)
    config["_recommendations"] = generate_recommendations(...)

    return config
```

#### 6.7 äº¤äº’å¼è°ƒå‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š æ˜¾å­˜åˆ†é…å¯è§†åŒ–                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  GPU 0 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 65.2/80 GB (81%)  â”‚
â”‚         â”œâ”€ æ¨¡å‹æƒé‡    14.0 GB â–ˆâ–ˆâ–ˆâ–ˆ                         â”‚
â”‚         â”œâ”€ ä¼˜åŒ–å™¨çŠ¶æ€  21.0 GB â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                       â”‚
â”‚         â”œâ”€ æ¢¯åº¦        14.0 GB â–ˆâ–ˆâ–ˆâ–ˆ                         â”‚
â”‚         â”œâ”€ æ¿€æ´»å€¼      12.2 GB â–ˆâ–ˆâ–ˆ                          â”‚
â”‚         â””â”€ KV Cache     4.0 GB â–ˆ                            â”‚
â”‚                                                             â”‚
â”‚  ğŸ”§ è°ƒå‚æ»‘å—                                                 â”‚
â”‚  Micro Batch Size: [====â—=====] 4                           â”‚
â”‚  Sequence Length:  [======â—===] 4096                        â”‚
â”‚  LoRA Rank:        [==â—=======] 16                          â”‚
â”‚                                                             â”‚
â”‚  å®æ—¶é¢„ä¼°: æ˜¾å­˜ 65.2GB â†’ è°ƒæ•´å 52.1GB âœ…                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ¨¡å—7ï¼šæ¨¡å‹æ‰‹æœ¯å° (Model Surgery)

> è®­ç»ƒç»“æŸåçš„æ¨¡å‹ä¼˜åŒ–ï¼šèåˆã€å¹³å‡ã€è£å‰ª

#### 7.1 æ ¸å¿ƒåŠŸèƒ½æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ¨¡å‹æ‰‹æœ¯å° Model Surgery                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  æ¨¡å‹èåˆ   â”‚  â”‚  æƒé‡å¹³å‡   â”‚  â”‚  æ¨¡å‹è£å‰ª   â”‚             â”‚
â”‚  â”‚  Merging    â”‚  â”‚  EMA/SWA    â”‚  â”‚  Pruning    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Checkpoint  â”‚  â”‚  é‡åŒ–å¯¼å‡º   â”‚  â”‚  æ ¼å¼è½¬æ¢   â”‚             â”‚
â”‚  â”‚  é€‰æ‹©å™¨     â”‚  â”‚  Quantize   â”‚  â”‚  Convert    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.2 æ¨¡å‹èåˆ (Model Merging)

##### ä¸ºä»€ä¹ˆéœ€è¦æ¨¡å‹èåˆï¼Ÿ

```
è®­ç»ƒæ›²çº¿å¾€å¾€ä¸æ˜¯å•è°ƒçš„:

Benchmark
Score
  â–²
  â”‚      â•­â”€â•®                    â† æœ€é«˜rewardç‚¹
  â”‚     â•±   â•²    â•­â”€â”€â”€â•®
  â”‚    â•±     â•²  â•±     â•² â•­â”€
  â”‚   â•±       â•²â•±       â•²â•±       â† æœ€åcheckpoint
  â”‚  â•±
  â”‚ â•±
  â”‚â•±
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Step

é—®é¢˜: æœ€ä½³checkpointä¸ä¸€å®šæ˜¯æœ€åä¸€ä¸ªï¼Œä¹Ÿä¸ä¸€å®šæ˜¯rewardæœ€é«˜çš„
è§£å†³: é€šè¿‡æ¨¡å‹èåˆè·å¾—"å…è´¹"çš„æ€§èƒ½æå‡
```

##### æ”¯æŒçš„èåˆæ–¹æ³•

**1. Linear Merge (çº¿æ€§æ’å€¼)**

```python
# æœ€ç®€å•çš„èåˆæ–¹å¼
merged_weights = alpha * model_A + (1 - alpha) * model_B

# å…¸å‹ç”¨æ³•: SFTåŸºåº§ + RLHFæ¨¡å‹
merged = 0.3 * sft_base + 0.7 * rlhf_model
```

**2. SLERP (Spherical Linear Interpolation)**

```python
def slerp(t, v0, v1, DOT_THRESHOLD=0.9995):
    """
    çƒé¢çº¿æ€§æ’å€¼ - åœ¨æƒé‡ç©ºé—´ä¸­æ²¿çƒé¢ç§»åŠ¨
    æ¯”çº¿æ€§æ’å€¼æ›´å¹³æ»‘ï¼Œæ•ˆæœé€šå¸¸æ›´å¥½
    """
    dot = np.sum(v0 * v1 / (np.linalg.norm(v0) * np.linalg.norm(v1)))

    if np.abs(dot) > DOT_THRESHOLD:
        return (1 - t) * v0 + t * v1  # é€€åŒ–ä¸ºçº¿æ€§æ’å€¼

    theta_0 = np.arccos(dot)
    sin_theta_0 = np.sin(theta_0)
    theta_t = theta_0 * t
    sin_theta_t = np.sin(theta_t)

    s0 = np.sin(theta_0 - theta_t) / sin_theta_0
    s1 = sin_theta_t / sin_theta_0

    return s0 * v0 + s1 * v1
```

**3. TIES (TrIm, Elect Sign & Merge)**

```python
def ties_merge(models, weights, density=0.5):
    """
    TIES: å…ˆè£å‰ªå°æƒé‡ï¼Œå†é€‰æ‹©ç¬¦å·ä¸€è‡´æ€§ï¼Œæœ€ååˆå¹¶
    é€‚ç”¨äºå¤šä¸ªå¾®è°ƒæ¨¡å‹çš„èåˆ
    """
    # Step 1: Trim - ä¿ç•™top-k%çš„å‚æ•°å˜åŒ–
    trimmed = [trim_small_changes(m, density) for m in models]

    # Step 2: Elect Sign - é€‰æ‹©ç¬¦å·ä¸€è‡´çš„æ–¹å‘
    signs = elect_sign(trimmed)

    # Step 3: Merge - åŠ æƒå¹³å‡
    merged = weighted_average(trimmed, weights, signs)

    return merged
```

**4. DARE (Drop And REscale)**

```python
def dare_merge(base_model, finetuned_models, drop_rate=0.9):
    """
    DARE: éšæœºä¸¢å¼ƒå¤§éƒ¨åˆ†deltaæƒé‡ï¼Œç„¶årescale
    å¯ä»¥åˆå¹¶æ›´å¤šæ¨¡å‹è€Œä¸æŸå¤±å¤ªå¤šæ€§èƒ½
    """
    for model in finetuned_models:
        delta = model - base_model
        # éšæœºä¸¢å¼ƒ
        mask = torch.rand_like(delta) > drop_rate
        delta = delta * mask
        # Rescale
        delta = delta / (1 - drop_rate)
        merged = base_model + delta
    return merged
```

##### èåˆé…ç½®ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸€é”®èåˆ (One-click Merge)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“¥ é€‰æ‹©æ¨¡å‹                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åŸºåº§æ¨¡å‹ (Base):                                         â”‚   â”‚
â”‚  â”‚   [Qwen/Qwen2.5-7B-Instruct           â–¼] [æµè§ˆ...]       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ RLHFæ¨¡å‹ (Finetuned):                                    â”‚   â”‚
â”‚  â”‚   [experiments/grpo-math-v1.2/ckpt-3000 â–¼] [æµè§ˆ...]     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ [+ æ·»åŠ æ›´å¤šæ¨¡å‹]                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  âš™ï¸ èåˆè®¾ç½®                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ èåˆæ–¹æ³•:  â—‹ Linear  â— SLERP  â—‹ TIES  â—‹ DARE            â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ æ’å€¼ç³»æ•° t: [=======â—===] 0.7                            â”‚   â”‚
â”‚  â”‚            (0.0 = çº¯Base, 1.0 = çº¯RLHF)                  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ â˜‘ èåˆåè‡ªåŠ¨è¯„ä¼° (GSM8K, MATH)                           â”‚   â”‚
â”‚  â”‚ â˜‘ ä¿å­˜èåˆé…ç½®ä»¥ä¾¿å¤ç°                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [é¢„è§ˆèåˆç»“æœ]  [å¼€å§‹èåˆ]  [æ‰¹é‡èåˆæ‰«æ]                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### æ‰¹é‡èåˆæ‰«æ

```python
# è‡ªåŠ¨æœç´¢æœ€ä½³èåˆæ¯”ä¾‹
def scan_merge_ratios(base_model, rlhf_model, eval_dataset):
    """
    æ‰«æä¸åŒèåˆæ¯”ä¾‹ï¼Œæ‰¾åˆ°æœ€ä½³é…ç½®
    """
    results = []
    for alpha in [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9]:
        merged = slerp_merge(base_model, rlhf_model, t=alpha)
        score = evaluate(merged, eval_dataset)
        results.append({"alpha": alpha, "score": score})

    # å¯è§†åŒ–ç»“æœ
    plot_merge_curve(results)
    return max(results, key=lambda x: x["score"])
```

```
èåˆæ¯”ä¾‹æ‰«æç»“æœ:

Score
  â–²
68â”‚           â—
  â”‚         â—   â—
66â”‚       â—       â—
  â”‚     â—           â—
64â”‚   â—               â—
  â”‚ â—                   â—
62â”‚
  â””â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â–º Alpha
     0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9
                          â†‘
                    æœ€ä½³æ¯”ä¾‹: 0.6
```

#### 7.3 æƒé‡å¹³å‡ (EMA/SWA)

##### EMA (Exponential Moving Average)

```python
class EMACallback:
    """
    è®­ç»ƒæ—¶ç»´æŠ¤EMAç‰ˆæœ¬çš„æƒé‡
    EMAæ¨¡å‹é€šå¸¸æ³›åŒ–æ€§æ›´å¥½ï¼Œå¯¹å™ªå£°æ›´é²æ£’
    """
    def __init__(self, decay=0.999):
        self.decay = decay
        self.ema_weights = None

    def on_step_end(self, model):
        if self.ema_weights is None:
            self.ema_weights = copy.deepcopy(model.state_dict())
        else:
            for key in self.ema_weights:
                self.ema_weights[key] = (
                    self.decay * self.ema_weights[key] +
                    (1 - self.decay) * model.state_dict()[key]
                )

    def get_ema_model(self, model):
        model.load_state_dict(self.ema_weights)
        return model
```

##### SWA (Stochastic Weight Averaging)

```python
def swa_average(checkpoints: List[str], start_step: int = None):
    """
    å¯¹è®­ç»ƒåæœŸçš„å¤šä¸ªcheckpointè¿›è¡Œå¹³å‡
    æ¯”é€‰æ‹©å•ä¸€checkpointæ›´ç¨³å®š
    """
    if start_step:
        checkpoints = [c for c in checkpoints if get_step(c) >= start_step]

    # åŠ è½½å¹¶å¹³å‡
    averaged_state = None
    for ckpt_path in checkpoints:
        state = torch.load(ckpt_path)
        if averaged_state is None:
            averaged_state = state
        else:
            for key in averaged_state:
                averaged_state[key] += state[key]

    # é™¤ä»¥checkpointæ•°é‡
    for key in averaged_state:
        averaged_state[key] /= len(checkpoints)

    return averaged_state
```

##### EMA vs SWA å¯¹æ¯”

| ç‰¹æ€§ | EMA | SWA |
|-----|-----|-----|
| è®¡ç®—æ—¶æœº | è®­ç»ƒæ—¶å®æ—¶æ›´æ–° | è®­ç»ƒåå¤„ç† |
| æ˜¾å­˜å¼€é”€ | éœ€é¢å¤–å­˜å‚¨ä¸€ä»½æƒé‡ | æ— é¢å¤–å¼€é”€ |
| é€‚ç”¨åœºæ™¯ | æŒç»­è®­ç»ƒã€åœ¨çº¿å­¦ä¹  | è®­ç»ƒå®Œæˆåä¼˜åŒ– |
| å…¸å‹æ•ˆæœ | 1-2% æå‡ | 0.5-1.5% æå‡ |

#### 7.4 Checkpoint æ™ºèƒ½é€‰æ‹©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Checkpoint é€‰æ‹©å™¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  è®­ç»ƒå®éªŒ: qwen2.5-7b-grpo-math-v1.2                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step  â”‚ Reward â”‚ GSM8K â”‚ MATH  â”‚ KL    â”‚ æ¨è  â”‚ æ“ä½œ   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 1000  â”‚ 0.42   â”‚ 52.3% â”‚ 15.8% â”‚ 0.08  â”‚       â”‚ [é€‰æ‹©] â”‚  â”‚
â”‚  â”‚ 2000  â”‚ 0.58   â”‚ 58.1% â”‚ 19.2% â”‚ 0.12  â”‚       â”‚ [é€‰æ‹©] â”‚  â”‚
â”‚  â”‚ 3000  â”‚ 0.71   â”‚ 61.5% â”‚ 22.5% â”‚ 0.15  â”‚ â­æœ€ä½³â”‚ [é€‰æ‹©] â”‚  â”‚
â”‚  â”‚ 4000  â”‚ 0.75   â”‚ 60.2% â”‚ 21.8% â”‚ 0.21  â”‚ âš è¿‡æ‹Ÿâ”‚ [é€‰æ‹©] â”‚  â”‚
â”‚  â”‚ 5000  â”‚ 0.73   â”‚ 59.1% â”‚ 20.5% â”‚ 0.28  â”‚       â”‚ [é€‰æ‹©] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“Š é€‰æ‹©ç­–ç•¥:                                                    â”‚
â”‚    â—‹ æœ€é«˜ Reward        â—‹ æœ€é«˜ Benchmark                        â”‚
â”‚    â— ç»¼åˆæœ€ä¼˜ (æ¨è)     â—‹ æœ€ä½ KL æ•£åº¦                          â”‚
â”‚    â—‹ è‡ªå®šä¹‰å…¬å¼: score = 0.5*gsm8k + 0.3*math - 0.2*kl          â”‚
â”‚                                                                 â”‚
â”‚  [æ‰¹é‡å¯¼å‡ºæ‰€é€‰]  [å¯¹æ¯”åˆ†æ]  [èåˆæ‰€é€‰Checkpoint]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.5 å®ç°æ¶æ„

```python
# æ¨¡å‹æ‰‹æœ¯å°æœåŠ¡
class ModelSurgeryService:

    def merge_models(
        self,
        base_model_path: str,
        models: List[str],
        method: str = "slerp",  # linear, slerp, ties, dare
        weights: List[float] = None,
        output_path: str = None,
        eval_after_merge: bool = True
    ) -> MergeResult:
        """æ‰§è¡Œæ¨¡å‹èåˆ"""
        pass

    def apply_ema(
        self,
        training_run_id: str,
        decay: float = 0.999,
        save_path: str = None
    ) -> str:
        """ä»è®­ç»ƒæ—¥å¿—ä¸­æå–EMAæƒé‡"""
        pass

    def swa_checkpoints(
        self,
        checkpoint_paths: List[str],
        output_path: str = None
    ) -> str:
        """å¯¹å¤šä¸ªcheckpointè¿›è¡ŒSWAå¹³å‡"""
        pass

    def scan_merge_ratios(
        self,
        base_model: str,
        finetuned_model: str,
        eval_dataset: str,
        method: str = "slerp",
        num_points: int = 9
    ) -> List[ScanResult]:
        """æ‰«ææœ€ä½³èåˆæ¯”ä¾‹"""
        pass

    def smart_checkpoint_select(
        self,
        experiment_id: str,
        criteria: str = "balanced",  # reward, benchmark, kl, balanced, custom
        custom_formula: str = None
    ) -> CheckpointRecommendation:
        """æ™ºèƒ½æ¨èæœ€ä½³checkpoint"""
        pass
```

#### 7.6 ä¸ verl çš„é›†æˆ

```python
# verl å·²æœ‰çš„æ¨¡å‹åˆå¹¶å·¥å…·
# ä½ç½®: verl/model_merger/

# æˆ‘ä»¬éœ€è¦å°è£…å¹¶å¢å¼º
from verl.model_merger import FSDPModelMerger, MegatronModelMerger

class PlatformModelMerger:
    def __init__(self):
        self.fsdp_merger = FSDPModelMerger()
        self.megatron_merger = MegatronModelMerger()

    def merge(self, config: MergeConfig) -> str:
        # æ ¹æ®æ¨¡å‹ç±»å‹é€‰æ‹©merger
        if config.model_type == "fsdp":
            return self.fsdp_merger.merge(...)
        else:
            return self.megatron_merger.merge(...)
```

---

## ä¸‰ã€æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | é€‰å‹ | ç†ç”± |
|------|------|------|
| åç«¯æ¡†æ¶ | FastAPI | å¼‚æ­¥æ”¯æŒå¥½ï¼Œé€‚åˆé•¿è¿æ¥ç›‘æ§ |
| ä»»åŠ¡é˜Ÿåˆ— | Celery + Redis | æˆç†Ÿç¨³å®šï¼Œæ”¯æŒä¼˜å…ˆçº§ |
| æ•°æ®åº“ | PostgreSQL | å¤æ‚æŸ¥è¯¢ï¼ŒJSONBæ”¯æŒé…ç½®å­˜å‚¨ |
| ç¼“å­˜ | Redis | å®æ—¶æŒ‡æ ‡ç¼“å­˜ |
| å¯¹è±¡å­˜å‚¨ | MinIO/S3 | checkpointå’Œæ•°æ®é›†å­˜å‚¨ |
| ç›‘æ§ | Prometheus + Grafana | ä¸šç•Œæ ‡å‡†ï¼Œverlå·²æœ‰é›†æˆæ–‡æ¡£ |
| æ—¥å¿—å¯è§†åŒ– | TensorBoard / W&B | verlåŸç”Ÿæ”¯æŒ |
| å‰ç«¯ | React + Ant Design | ä¼ä¸šçº§UIç»„ä»¶ |
| å›¾è¡¨ | ECharts | çƒ­åŠ›å›¾ã€æ—¶åºå›¾æ”¯æŒå¥½ |
| WebSocket | Socket.IO | å®æ—¶æ•°æ®æ¨é€ |

---

## å››ã€ç›®å½•ç»“æ„

```
train_platform/
â”œâ”€â”€ verl/                      # verlæ¡†æ¶ï¼ˆå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ platform/                  # å¹³å°ä»£ç 
â”‚   â”œâ”€â”€ api/                   # FastAPIåç«¯
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”‚   â”œâ”€â”€ datasets.py    # æ•°æ®é›†API
â”‚   â”‚   â”‚   â”œâ”€â”€ jobs.py        # è®­ç»ƒä»»åŠ¡API
â”‚   â”‚   â”‚   â”œâ”€â”€ monitoring.py  # ç›‘æ§API
â”‚   â”‚   â”‚   â”œâ”€â”€ evaluation.py  # è¯„ä¼°API
â”‚   â”‚   â”‚   â”œâ”€â”€ experiments.py # å®éªŒç®¡ç†API
â”‚   â”‚   â”‚   â”œâ”€â”€ compute.py     # ç®—åŠ›è®¡ç®—å™¨API
â”‚   â”‚   â”‚   â””â”€â”€ surgery.py     # æ¨¡å‹æ‰‹æœ¯å°API
â”‚   â”‚   â”œâ”€â”€ models/            # Pydanticæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”œâ”€â”€ workers/               # Celeryå¼‚æ­¥ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ training.py        # è®­ç»ƒä»»åŠ¡worker
â”‚   â”‚   â”œâ”€â”€ evaluation.py      # è¯„ä¼°ä»»åŠ¡worker
â”‚   â”‚   â””â”€â”€ monitoring.py      # æŒ‡æ ‡é‡‡é›†worker
â”‚   â”œâ”€â”€ core/                  # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ verl_adapter.py    # verlé€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ metrics_collector.py
â”‚   â”‚   â”œâ”€â”€ checkpoint_manager.py
â”‚   â”‚   â”œâ”€â”€ alert_manager.py
â”‚   â”‚   â”œâ”€â”€ compute_calculator.py  # ç®—åŠ›è®¡ç®—å™¨æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ memory_estimator.py    # æ˜¾å­˜ä¼°ç®—
â”‚   â”‚   â”œâ”€â”€ model_merger.py        # æ¨¡å‹èåˆ
â”‚   â”‚   â”œâ”€â”€ ema_manager.py         # EMAæƒé‡ç®¡ç†
â”‚   â”‚   â””â”€â”€ checkpoint_selector.py # æ™ºèƒ½checkpointé€‰æ‹©
â”‚   â”œâ”€â”€ frontend/              # Reactå‰ç«¯
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Dashboard.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DatasetManager.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TrainingMonitor.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EvaluationReport.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExperimentTracker.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ComputeCalculator.tsx  # ç®—åŠ›è®¡ç®—å™¨é¡µé¢
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ModelSurgery.tsx       # æ¨¡å‹æ‰‹æœ¯å°é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚   â”‚       â”œâ”€â”€ GradientHeatmap.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ LossCurve.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ MetricsCard.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ MemoryVisualizer.tsx   # æ˜¾å­˜å¯è§†åŒ–
â”‚   â”‚   â”‚       â”œâ”€â”€ MergeRatioSlider.tsx   # èåˆæ¯”ä¾‹æ»‘å—
â”‚   â”‚   â”‚       â””â”€â”€ CheckpointTable.tsx    # Checkpointé€‰æ‹©è¡¨æ ¼
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ configs/               # å¹³å°é…ç½®
â”‚       â”œâ”€â”€ default.yaml
â”‚       â””â”€â”€ alerts.yaml
â”œâ”€â”€ docker-compose.yml         # ä¸€é”®éƒ¨ç½²
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ setup.sh
â”‚   â””â”€â”€ migrate_db.py
â””â”€â”€ README.md
```

---

## äº”ã€å…³é”®å®ç°è¦ç‚¹

### 5.1 ä¸verlçš„é›†æˆæ–¹å¼

verlå·²æœ‰å®Œå–„çš„ç›‘æ§é›†æˆï¼ˆè§ `docs/advance/grafana_prometheus.md`ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. **Hook verlçš„callbackæœºåˆ¶**: åœ¨ `ray_trainer.py` ä¸­æ³¨å…¥è‡ªå®šä¹‰callback
2. **åˆ©ç”¨verlçš„profiler**: `verl/utils/profiler/` å·²æœ‰æ€§èƒ½åˆ†æå·¥å…·
3. **å¤ç”¨verlçš„checkpointæœºåˆ¶**: `verl/utils/checkpoint/`
4. **å¯¹æ¥verlçš„æ—¥å¿—ç³»ç»Ÿ**: `verl/utils/logger/` æ”¯æŒwandbç­‰

### 5.2 æ¢¯åº¦çƒ­åŠ›å›¾é‡‡é›†

```python
class GradientMonitorCallback:
    """è‡ªå®šä¹‰æ¢¯åº¦ç›‘æ§å›è°ƒ"""

    def __init__(self, collect_interval: int = 100):
        self.collect_interval = collect_interval

    def on_backward_end(self, trainer, model):
        if trainer.global_step % self.collect_interval == 0:
            grad_stats = {}
            for name, param in model.named_parameters():
                if param.grad is not None:
                    grad_stats[name] = {
                        "mean": param.grad.mean().item(),
                        "std": param.grad.std().item(),
                        "max": param.grad.max().item(),
                        "min": param.grad.min().item(),
                    }
            self.send_to_metrics_server(grad_stats)
```

### 5.3 å¼‚æ­¥è¯„ä¼°æœºåˆ¶

```python
# è®­ç»ƒä¸»è¿›ç¨‹
def on_checkpoint_saved(path):
    celery_app.send_task("evaluate_checkpoint", args=[path, eval_config])

# Celery worker
@celery_app.task
def evaluate_checkpoint(ckpt_path, eval_config):
    model = load_model(ckpt_path)
    results = run_evaluation(model, eval_config.benchmarks)
    save_results_to_db(results)
    notify_frontend_via_websocket(results)
```

### 5.4 verlé…ç½®ç”Ÿæˆ

```python
def generate_verl_config(job_config: dict) -> dict:
    """å°†å¹³å°ä»»åŠ¡é…ç½®è½¬æ¢ä¸ºverlçš„Hydraé…ç½®"""
    base = load_yaml(f"verl/examples/{job_config['base_config']}/config.yaml")

    # åº”ç”¨è¦†ç›–
    for key, value in job_config["overrides"].items():
        set_nested_value(base, key, value)

    # æ³¨å…¥ç›‘æ§é…ç½®
    base["trainer"]["callbacks"] = [
        "platform.core.metrics_collector.MetricsCallback",
        "platform.core.checkpoint_manager.CheckpointCallback",
    ]

    return base
```

---

## å…­ã€å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ - MVP (åŸºç¡€åŠŸèƒ½)

- [ ] è®­ç»ƒä»»åŠ¡æäº¤ä¸ç®¡ç†
- [ ] åŸºç¡€æŒ‡æ ‡ç›‘æ§ï¼ˆlossã€rewardã€klï¼‰
- [ ] ç®€å•çš„Webç•Œé¢å±•ç¤º
- [ ] verlåŸºç¡€é›†æˆ
- [ ] **ç®—åŠ›è®¡ç®—å™¨ - åŸºç¡€ç‰ˆ** (æ˜¾å­˜ä¼°ç®— + é…ç½®æ¨è)

### ç¬¬äºŒé˜¶æ®µ - ç›‘æ§å¢å¼º

- [ ] æ¢¯åº¦çƒ­åŠ›å›¾
- [ ] å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ
- [ ] checkpointè‡ªåŠ¨è¯„ä¼°
- [ ] èµ„æºç›‘æ§é¢æ¿
- [ ] **ç®—åŠ›è®¡ç®—å™¨ - å®Œæ•´ç‰ˆ** (äº¤äº’å¼è°ƒå‚ + å¯è§†åŒ–)

### ç¬¬ä¸‰é˜¶æ®µ - å®Œæ•´å¹³å°

- [ ] æ•°æ®é›†ç®¡ç†ç³»ç»Ÿ
- [ ] è¿­ä»£è¿½è¸ª
- [ ] å®éªŒå¯¹æ¯”åˆ†æ
- [ ] è¯„ä¼°æŠ¥å‘Šç”Ÿæˆ
- [ ] **æ¨¡å‹æ‰‹æœ¯å° - åŸºç¡€ç‰ˆ** (æ¨¡å‹èåˆ + checkpointé€‰æ‹©)

### ç¬¬å››é˜¶æ®µ - é«˜çº§åŠŸèƒ½

- [ ] è‡ªåŠ¨è¶…å‚æœç´¢
- [ ] å¤šç§Ÿæˆ·æ”¯æŒ
- [ ] æ¨¡å‹ç‰ˆæœ¬ç®¡ç†
- [ ] A/Bæµ‹è¯•æ¡†æ¶
- [ ] **æ¨¡å‹æ‰‹æœ¯å° - å®Œæ•´ç‰ˆ** (EMA/SWA + æ‰¹é‡æ‰«æ + é‡åŒ–å¯¼å‡º)

---

## ä¸ƒã€verlæ¡†æ¶æ¦‚è§ˆ

### 7.1 æ ¸å¿ƒç‰¹æ€§

- **çµæ´»çš„RLç®—æ³•**: PPOã€GRPOã€DAPOã€ReMaxã€RLOOç­‰15+ç§ç®—æ³•
- **å¤šå¼•æ“æ”¯æŒ**: FSDPã€Megatron-LMè®­ç»ƒï¼›vLLMã€SGLangæ¨ç†
- **å¤§è§„æ¨¡æ”¯æŒ**: å·²éªŒè¯671B DeepSeekã€235B Qwen3æ¨¡å‹
- **é«˜æ€§èƒ½**: 3D-HybridEngineæ¶ˆé™¤å†…å­˜å†—ä½™

### 7.2 å…³é”®ç›®å½•

```
verl/
â”œâ”€â”€ trainer/           # è®­ç»ƒæ ¸å¿ƒï¼ˆmain_ppo.py, sft_trainer.pyï¼‰
â”œâ”€â”€ workers/           # åˆ†å¸ƒå¼Workerï¼ˆactor, critic, rolloutï¼‰
â”œâ”€â”€ utils/             # å·¥å…·åº“ï¼ˆcheckpoint, logger, profilerï¼‰
â””â”€â”€ experimental/      # å®éªŒåŠŸèƒ½ï¼ˆagent_loop, reward_loopï¼‰
```

### 7.3 å·²æœ‰ç›‘æ§é›†æˆ

- Prometheus metrics export
- Grafana dashboard templates
- TensorBoard logging
- Weights & Biases integration

---

## å…«ã€å‚è€ƒèµ„æº

- verlå®˜æ–¹æ–‡æ¡£: https://verl.readthedocs.io/
- verl GitHub: https://github.com/volcengine/verl
- Grafanaé›†æˆæ–‡æ¡£: `verl/docs/advance/grafana_prometheus.md`
- Profileræ–‡æ¡£: `verl/docs/perf/verl_profiler_system.md`
